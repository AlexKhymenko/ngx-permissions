/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Inject, Injectable, InjectionToken } from '@angular/core';
import { BehaviorSubject, from, of } from 'rxjs';
import { catchError, every, first, map, mergeAll, mergeMap, switchMap } from 'rxjs/operators';
import { NgxRolesStore } from '../store/roles.store';
import { isBoolean, isFunction, isPromise, transformStringToArray } from '../utils/utils';
import { NgxPermissionsService } from './permissions.service';
/** @type {?} */
export var USE_ROLES_STORE = new InjectionToken('USE_ROLES_STORE');
var NgxRolesService = /** @class */ (function () {
    function NgxRolesService(isolate, rolesStore, permissionsService) {
        if (isolate === void 0) { isolate = false; }
        this.isolate = isolate;
        this.rolesStore = rolesStore;
        this.permissionsService = permissionsService;
        this.rolesSource = this.isolate ? new BehaviorSubject({}) : this.rolesStore.rolesSource;
        this.roles$ = this.rolesSource.asObservable();
    }
    /**
     * @param {?} name
     * @param {?} validationFunction
     * @return {?}
     */
    NgxRolesService.prototype.addRole = /**
     * @param {?} name
     * @param {?} validationFunction
     * @return {?}
     */
    function (name, validationFunction) {
        var _a;
        /** @type {?} */
        var roles = tslib_1.__assign({}, this.rolesSource.value, (_a = {}, _a[name] = { name: name, validationFunction: validationFunction }, _a));
        this.rolesSource.next(roles);
    };
    /**
     * @param {?} rolesObj
     * @return {?}
     */
    NgxRolesService.prototype.addRoles = /**
     * @param {?} rolesObj
     * @return {?}
     */
    function (rolesObj) {
        var _this = this;
        Object.keys(rolesObj).forEach((/**
         * @param {?} key
         * @param {?} index
         * @return {?}
         */
        function (key, index) {
            _this.addRole(key, rolesObj[key]);
        }));
    };
    /**
     * @return {?}
     */
    NgxRolesService.prototype.flushRoles = /**
     * @return {?}
     */
    function () {
        this.rolesSource.next({});
    };
    /**
     * @param {?} roleName
     * @return {?}
     */
    NgxRolesService.prototype.removeRole = /**
     * @param {?} roleName
     * @return {?}
     */
    function (roleName) {
        /** @type {?} */
        var roles = tslib_1.__assign({}, this.rolesSource.value);
        delete roles[roleName];
        this.rolesSource.next(roles);
    };
    /**
     * @return {?}
     */
    NgxRolesService.prototype.getRoles = /**
     * @return {?}
     */
    function () {
        return this.rolesSource.value;
    };
    /**
     * @param {?} name
     * @return {?}
     */
    NgxRolesService.prototype.getRole = /**
     * @param {?} name
     * @return {?}
     */
    function (name) {
        return this.rolesSource.value[name];
    };
    /**
     * @param {?} names
     * @return {?}
     */
    NgxRolesService.prototype.hasOnlyRoles = /**
     * @param {?} names
     * @return {?}
     */
    function (names) {
        /** @type {?} */
        var isNamesEmpty = !names || (Array.isArray(names) && names.length === 0);
        if (isNamesEmpty)
            return Promise.resolve(true);
        names = transformStringToArray(names);
        return Promise.all([this.hasRoleKey(names), this.hasRolePermission(this.rolesSource.value, names)])
            .then((/**
         * @param {?} __0
         * @return {?}
         */
        function (_a) {
            var _b = tslib_1.__read(_a, 2), hasRoles = _b[0], hasPermissions = _b[1];
            return hasRoles || hasPermissions;
        }));
    };
    /**
     * @private
     * @param {?} roleName
     * @return {?}
     */
    NgxRolesService.prototype.hasRoleKey = /**
     * @private
     * @param {?} roleName
     * @return {?}
     */
    function (roleName) {
        var _this = this;
        /** @type {?} */
        var promises = roleName.map((/**
         * @param {?} key
         * @return {?}
         */
        function (key) {
            /** @type {?} */
            var hasValidationFunction = !!_this.rolesSource.value[key] &&
                !!_this.rolesSource.value[key].validationFunction &&
                isFunction(_this.rolesSource.value[key].validationFunction);
            if (hasValidationFunction && !isPromise(_this.rolesSource.value[key].validationFunction)) {
                /** @type {?} */
                var validationFunction_1 = (/** @type {?} */ (_this.rolesSource.value[key].validationFunction));
                return of(null).pipe(map((/**
                 * @return {?}
                 */
                function () { return validationFunction_1(); })), switchMap((/**
                 * @param {?} promise
                 * @return {?}
                 */
                function (promise) { return isBoolean(promise) ?
                    of((/** @type {?} */ (promise))) : (/** @type {?} */ (promise)); })), catchError((/**
                 * @return {?}
                 */
                function () { return of(false); })));
            }
            return of(false);
        }));
        return from(promises).pipe(mergeAll(), first((/**
         * @param {?} data
         * @return {?}
         */
        function (data) { return data !== false; }), false), map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) { return data !== false; }))).toPromise().then((/**
         * @param {?} data
         * @return {?}
         */
        function (data) { return data; }));
    };
    /**
     * @private
     * @param {?} roles
     * @param {?} roleNames
     * @return {?}
     */
    NgxRolesService.prototype.hasRolePermission = /**
     * @private
     * @param {?} roles
     * @param {?} roleNames
     * @return {?}
     */
    function (roles, roleNames) {
        var _this = this;
        return from(roleNames).pipe(mergeMap((/**
         * @param {?} key
         * @return {?}
         */
        function (key) {
            if (roles[key] && Array.isArray(roles[key].validationFunction)) {
                return from((/** @type {?} */ (roles[key].validationFunction))).pipe(mergeMap((/**
                 * @param {?} permission
                 * @return {?}
                 */
                function (permission) { return _this.permissionsService.hasPermission(permission); })), every((/**
                 * @param {?} hasPermissions
                 * @return {?}
                 */
                function (hasPermissions) { return hasPermissions === true; })));
            }
            return of(false);
        })), first((/**
         * @param {?} hasPermission
         * @return {?}
         */
        function (hasPermission) { return hasPermission === true; }), false)).toPromise();
    };
    NgxRolesService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    NgxRolesService.ctorParameters = function () { return [
        { type: Boolean, decorators: [{ type: Inject, args: [USE_ROLES_STORE,] }] },
        { type: NgxRolesStore },
        { type: NgxPermissionsService }
    ]; };
    return NgxRolesService;
}());
export { NgxRolesService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    NgxRolesService.prototype.rolesSource;
    /** @type {?} */
    NgxRolesService.prototype.roles$;
    /**
     * @type {?}
     * @private
     */
    NgxRolesService.prototype.isolate;
    /**
     * @type {?}
     * @private
     */
    NgxRolesService.prototype.rolesStore;
    /**
     * @type {?}
     * @private
     */
    NgxRolesService.prototype.permissionsService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm9sZXMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1wZXJtaXNzaW9ucy8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlL3JvbGVzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFbkUsT0FBTyxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQStCLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5RSxPQUFPLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHOUYsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzFGLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDOztBQUU5RCxNQUFNLEtBQU8sZUFBZSxHQUFHLElBQUksY0FBYyxDQUFDLGlCQUFpQixDQUFDO0FBSXBFO0lBT0kseUJBQ3FDLE9BQXdCLEVBQ2pELFVBQXlCLEVBQ3pCLGtCQUF5QztRQUZoQix3QkFBQSxFQUFBLGVBQXdCO1FBQXhCLFlBQU8sR0FBUCxPQUFPLENBQWlCO1FBQ2pELGVBQVUsR0FBVixVQUFVLENBQWU7UUFDekIsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUF1QjtRQUVqRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksZUFBZSxDQUFpQixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUM7UUFDeEcsSUFBSSxDQUFDLE1BQU0sR0FBRyxJ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LENBQUMsQ0FBQyxJQUFJLENBQ3ZCLFFBQVE7Ozs7UUFBQyxVQUFDLEdBQUc7WUFDVCxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFO2dCQUM1RCxPQUFPLElBQUksQ0FBQyxtQkFBVSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsa0JBQWtCLEVBQUEsQ0FBQyxDQUFDLElBQUksQ0FDckQsUUFBUTs7OztnQkFBQyxVQUFDLFVBQVUsSUFBSyxPQUFBLEtBQUksQ0FBQyxrQkFBa0IsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLEVBQWpELENBQWlELEVBQUMsRUFDM0UsS0FBSzs7OztnQkFBQyxVQUFDLGNBQWMsSUFBSyxPQUFBLGNBQWMsS0FBSyxJQUFJLEVBQXZCLENBQXVCLEVBQUMsQ0FDckQsQ0FBQzthQUNMO1lBRUQsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDckIsQ0FBQyxFQUFDLEVBQ0YsS0FBSzs7OztRQUFDLFVBQUMsYUFBYSxJQUFLLE9BQUEsYUFBYSxLQUFLLElBQUksRUFBdEIsQ0FBc0IsR0FBRSxLQUFLLENBQUMsQ0FDMUQsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUNsQixDQUFDOztnQkF4R0osVUFBVTs7Ozs4Q0FRRixNQUFNLFNBQUMsZUFBZTtnQkFoQnRCLGFBQWE7Z0JBRWIscUJBQXFCOztJQWdIOUIsc0JBQUM7Q0FBQSxBQTFHRCxJQTBHQztTQXpHWSxlQUFlOzs7Ozs7SUFFeEIsc0NBQXFEOztJQUVyRCxpQ0FBMEM7Ozs7O0lBR3RDLGtDQUF5RDs7Ozs7SUFDekQscUNBQWlDOzs7OztJQUNqQyw2Q0FBaUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdGlvblRva2VuIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGZyb20sIE9ic2VydmFibGUsIE9ic2VydmFibGVJbnB1dCwgb2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgY2F0Y2hFcnJvciwgZXZlcnksIGZpcnN0LCBtYXAsIG1lcmdlQWxsLCBtZXJnZU1hcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuaW1wb3J0IHsgTmd4Um9sZSB9IGZyb20gJy4uL21vZGVsL3JvbGUubW9kZWwnO1xyXG5pbXBvcnQgeyBOZ3hSb2xlc1N0b3JlIH0gZnJvbSAnLi4vc3RvcmUvcm9sZXMuc3RvcmUnO1xyXG5pbXBvcnQgeyBpc0Jvb2xlYW4sIGlzRnVuY3Rpb24sIGlzUHJvbWlzZSwgdHJhbnNmb3JtU3RyaW5nVG9BcnJheSB9IGZyb20gJy4uL3V0aWxzL3V0aWxzJztcclxuaW1wb3J0IHsgTmd4UGVybWlzc2lvbnNTZXJ2aWNlIH0gZnJvbSAnLi9wZXJtaXNzaW9ucy5zZXJ2aWNlJztcclxuXHJcbmV4cG9ydCBjb25zdCBVU0VfUk9MRVNfU1RPUkUgPSBuZXcgSW5qZWN0aW9uVG9rZW4oJ1VTRV9ST0xFU19TVE9SRScpO1xyXG5cclxuZXhwb3J0IHR5cGUgTmd4Um9sZXNPYmplY3QgPSB7IFtuYW1lOiBzdHJpbmddOiBOZ3hSb2xlIH07XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBOZ3hSb2xlc1NlcnZpY2Uge1xyXG5cclxuICAgIHByaXZhdGUgcm9sZXNTb3VyY2U6IEJlaGF2aW9yU3ViamVjdDxOZ3hSb2xlc09iamVjdD47XHJcblxyXG4gICAgcHVibGljIHJvbGVzJDogT2JzZXJ2YWJsZTxOZ3hSb2xlc09iamVjdD47XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgQEluamVjdChVU0VfUk9MRVNfU1RPUkUpIHByaXZhdGUgaXNvbGF0ZTogYm9vbGVhbiA9IGZhbHNlLFxyXG4gICAgICAgIHByaXZhdGUgcm9sZXNTdG9yZTogTmd4Um9sZXNTdG9yZSxcclxuICAgICAgICBwcml2YXRlIHBlcm1pc3Npb25zU2VydmljZTogTmd4UGVybWlzc2lvbnNTZXJ2aWNlXHJcbiAgICApIHtcclxuICAgICAgICB0aGlzLnJvbGVzU291cmNlID0gdGhpcy5pc29sYXRlID8gbmV3IEJlaGF2aW9yU3ViamVjdDxOZ3hSb2xlc09iamVjdD4oe30pIDogdGhpcy5yb2xlc1N0b3JlLnJvbGVzU291cmNlO1xyXG4gICAgICAgIHRoaXMucm9sZXMkID0gdGhpcy5yb2xlc1NvdXJjZS5hc09ic2VydmFibGUoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYWRkUm9sZShuYW1lOiBzdHJpbmcsIHZhbGlkYXRpb25GdW5jdGlvbjogRnVuY3Rpb24gfCBzdHJpbmdbXSkge1xyXG4gICAgICAgIGNvbnN0IHJvbGVzID0ge1xyXG4gICAgICAgICAgICAuLi50aGlzLnJvbGVzU291cmNlLnZhbHVlLFxyXG4gICAgICAgICAgICBbbmFtZV06IHtuYW1lLCB2YWxpZGF0aW9uRnVuY3Rpb259XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLnJvbGVzU291cmNlLm5leHQocm9sZXMpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhZGRSb2xlcyhyb2xlc09iajogeyBbbmFtZTogc3RyaW5nXTogRnVuY3Rpb24gfCBzdHJpbmdbXSB9KSB7XHJcbiAgICAgICAgT2JqZWN0LmtleXMocm9sZXNPYmopLmZvckVhY2goKGtleSwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5hZGRSb2xlKGtleSwgcm9sZXNPYmpba2V5XSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGZsdXNoUm9sZXMoKSB7XHJcbiAgICAgICAgdGhpcy5yb2xlc1NvdXJjZS5uZXh0KHt9KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcmVtb3ZlUm9sZShyb2xlTmFtZTogc3RyaW5nKSB7XHJcbiAgICAgICAgbGV0IHJvbGVzID0ge1xyXG4gICAgICAgICAgICAuLi50aGlzLnJvbGVzU291cmNlLnZhbHVlXHJcbiAgICAgICAgfTtcclxuICAgICAgICBkZWxldGUgcm9sZXNbcm9sZU5hbWVdO1xyXG4gICAgICAgIHRoaXMucm9sZXNTb3VyY2UubmV4dChyb2xlcyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldFJvbGVzKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnJvbGVzU291cmNlLnZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRSb2xlKG5hbWU6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnJvbGVzU291cmNlLnZhbHVlW25hbWVdO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBoYXNPbmx5Um9sZXMobmFtZXM6IHN0cmluZyB8IHN0cmluZ1tdKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICAgICAgY29uc3QgaXNOYW1lc0VtcHR5ID0gIW5hbWVzIHx8IChBcnJheS5pc0FycmF5KG5hbWVzKSAmJiBuYW1lcy5sZW5ndGggPT09IDApO1xyXG5cclxuICAgICAgICBpZiAoaXNOYW1lc0VtcHR5KSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRydWUpO1xyXG5cclxuICAgICAgICBuYW1lcyA9IHRyYW5zZm9ybVN0cmluZ1RvQXJyYXkobmFtZXMpO1xyXG5cclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW3RoaXMuaGFzUm9sZUtleShuYW1lcyksIHRoaXMuaGFzUm9sZVBlcm1pc3Npb24odGhpcy5yb2xlc1NvdXJjZS52YWx1ZSwgbmFtZXMpXSlcclxuICAgICAgICAgICAgLnRoZW4oKFtoYXNSb2xlcywgaGFzUGVybWlzc2lvbnNdOiBbYm9vbGVhbiwgYm9vbGVhbl0pID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBoYXNSb2xlcyB8fCBoYXNQZXJtaXNzaW9ucztcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBoYXNSb2xlS2V5KHJvbGVOYW1lOiBzdHJpbmdbXSk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgICAgIGNvbnN0IHByb21pc2VzOiBPYnNlcnZhYmxlPGJvb2xlYW4+W10gPSByb2xlTmFtZS5tYXAoKGtleSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBoYXNWYWxpZGF0aW9uRnVuY3Rpb24gPSAhIXRoaXMucm9sZXNTb3VyY2UudmFsdWVba2V5XSAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAhIXRoaXMucm9sZXNTb3VyY2UudmFsdWVba2V5XS52YWxpZGF0aW9uRnVuY3Rpb24gJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNGdW5jdGlvbih0aGlzLnJvbGVzU291cmNlLnZhbHVlW2tleV0udmFsaWRhdGlvbkZ1bmN0aW9uKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChoYXNWYWxpZGF0aW9uRnVuY3Rpb24gJiYgIWlzUHJvbWlzZSh0aGlzLnJvbGVzU291cmNlLnZhbHVlW2tleV0udmFsaWRhdGlvbkZ1bmN0aW9uKSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdmFsaWRhdGlvbkZ1bmN0aW9uOiBGdW5jdGlvbiA9IDxGdW5jdGlvbj50aGlzLnJvbGVzU291cmNlLnZhbHVlW2tleV0udmFsaWRhdGlvbkZ1bmN0aW9uO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBvZihudWxsKS5waXBlKFxyXG4gICAgICAgICAgICAgICAgICAgIG1hcCgoKSA9PiB2YWxpZGF0aW9uRnVuY3Rpb24oKSksXHJcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoTWFwKChwcm9taXNlOiBQcm9taXNlPGJvb2xlYW4+IHwgYm9vbGVhbik6IE9ic2VydmFibGVJbnB1dDxib29sZWFuPiA9PiBpc0Jvb2xlYW4ocHJvbWlzZSkgP1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvZihwcm9taXNlIGFzIGJvb2xlYW4pIDogcHJvbWlzZSBhcyBQcm9taXNlPGJvb2xlYW4+KSxcclxuICAgICAgICAgICAgICAgICAgICBjYXRjaEVycm9yKCgpID0+IG9mKGZhbHNlKSlcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBmcm9tKHByb21pc2VzKS5waXBlKFxyXG4gICAgICAgICAgICBtZXJnZUFsbCgpLFxyXG4gICAgICAgICAgICBmaXJzdCgoZGF0YTogYW55KSA9PiBkYXRhICE9PSBmYWxzZSwgZmFsc2UpLFxyXG4gICAgICAgICAgICBtYXAoKGRhdGEpID0+IGRhdGEgIT09IGZhbHNlKVxyXG4gICAgICAgICkudG9Qcm9taXNlKCkudGhlbigoZGF0YTogYW55KSA9PiBkYXRhKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGhhc1JvbGVQZXJtaXNzaW9uKHJvbGVzOiBOZ3hSb2xlc09iamVjdCwgcm9sZU5hbWVzOiBzdHJpbmdbXSk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgICAgIHJldHVybiBmcm9tKHJvbGVOYW1lcykucGlwZShcclxuICAgICAgICAgICAgbWVyZ2VNYXAoKGtleSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJvbGVzW2tleV0gJiYgQXJyYXkuaXNBcnJheShyb2xlc1trZXldLnZhbGlkYXRpb25GdW5jdGlvbikpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnJvbSg8c3RyaW5nW10+cm9sZXNba2V5XS52YWxpZGF0aW9uRnVuY3Rpb24pLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlTWFwKChwZXJtaXNzaW9uKSA9PiB0aGlzLnBlcm1pc3Npb25zU2VydmljZS5oYXNQZXJtaXNzaW9uKHBlcm1pc3Npb24pKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXZlcnkoKGhhc1Blcm1pc3Npb25zKSA9PiBoYXNQZXJtaXNzaW9ucyA9PT0gdHJ1ZSlcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICBmaXJzdCgoaGFzUGVybWlzc2lvbikgPT4gaGFzUGVybWlzc2lvbiA9PT0gdHJ1ZSwgZmFsc2UpXHJcbiAgICAgICAgKS50b1Byb21pc2UoKTtcclxuICAgIH1cclxuXHJcbn1cclxuIl19