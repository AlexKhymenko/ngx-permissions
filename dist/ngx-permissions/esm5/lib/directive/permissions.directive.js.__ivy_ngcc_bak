/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChangeDetectorRef, Directive, EventEmitter, Input, Output, TemplateRef, ViewContainerRef } from '@angular/core';
import { merge, from } from 'rxjs';
import { skip, take, mergeAll, first, map } from 'rxjs/operators';
import { NgxPermissionsPredefinedStrategies } from '../enums/predefined-strategies.enum';
import { NgxPermissionsConfigurationService } from '../service/configuration.service';
import { NgxPermissionsService } from '../service/permissions.service';
import { NgxRolesService } from '../service/roles.service';
import { isBoolean, isFunction, isString, notEmptyValue, transformStringToArray } from '../utils/utils';
import { isArray } from 'util';
var NgxPermissionsDirective = /** @class */ (function () {
    function NgxPermissionsDirective(permissionsService, configurationService, rolesService, viewContainer, changeDetector, templateRef) {
        this.permissionsService = permissionsService;
        this.configurationService = configurationService;
        this.rolesService = rolesService;
        this.viewContainer = viewContainer;
        this.changeDetector = changeDetector;
        this.templateRef = templateRef;
        this.permissionsAuthorized = new EventEmitter();
        this.permissionsUnauthorized = new EventEmitter();
        // skip first run cause merge will fire twice
        this.firstMergeUnusedRun = 1;
        this.permissionsState = {};
    }
    /**
     * @return {?}
     */
    NgxPermissionsDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.viewContainer.clear();
        this.initPermissionSubscription = this.validateExceptOnlyPermissions();
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    NgxPermissionsDirective.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        var _this = this;
        /** @type {?} */
        var onlyChanges = changes['ngxPermissionsOnly'];
        /** @type {?} */
        var exceptChanges = changes['ngxPermissionsExcept'];
        if (onlyChanges || exceptChanges) {
            // Due to bug when you pass empty array
            if (onlyChanges && onlyChanges.firstChange)
                return;
            if (exceptChanges && exceptChanges.firstChange)
                return;
            merge(this.permissionsService.permissions$, this.rolesService.roles$)
                .pipe(skip(this.firstMergeUnusedRun), take(1))
                .subscribe((/**
             * @return {?}
             */
            function () {
                if (notEmptyValue(_this.ngxPermissionsExcept)) {
                    _this.validateExceptAndOnlyPermissions();
                    return;
                }
                if (notEmptyValue(_this.ngxPermissionsOnly)) {
                    _this.validateOnlyPermissions();
                    return;
                }
                _this.handleAuthorisedPermission(_this.getAuthorisedTemplates());
            }));
        }
    };
    /**
     * @return {?}
     */
    NgxPermissionsDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (this.initPermissionSubscription) {
            this.initPermissionSubscription.unsubscribe();
        }
    };
    /**
     * @private
     * @return {?}
     */
    NgxPermissionsDirective.prototype.validateExceptOnlyPermissions = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        return merge(this.permissionsService.permissions$, this.rolesService.roles$)
            .pipe(skip(this.firstMergeUnusedRun))
            .subscribe((/**
         * @return {?}
         */
        function () {
            if (notEmptyValue(_this.ngxPermissionsExcept)) {
                _this.validateExceptAndOnlyPermissions();
                return;
            }
            if (notEmptyValue(_this.ngxPermissionsOnly)) {
                _this.validateOnlyPermissions();
                return;
            }
            _this.handleAuthorisedPermission(_this.getAuthorisedTemplates());
        }));
    };
    /**
     * @private
     * @return {?}
     */
    NgxPermissionsDirective.prototype.validateExceptAndOnlyPermissions = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        this.getPermissions(this.ngxPermissionsExcept)
            .then((/**
         * @param {?} hasPermission
         * @return {?}
         */
        function (hasPermission) {
            if (hasPermission) {
                _this.handleUnauthorisedPermission(_this.ngxPermissionsExceptElse || _this.ngxPermissionsElse);
                return;
            }
            if (!!_this.ngxPermissionsOnly)
                throw false;
            _this.handleAuthorisedPermission(_this.ngxPermissionsExceptThen || _this.ngxPermissionsThen || _this.templateRef);
        }))
            .catch((/**
         * @return {?}
         */
        function () {
            if (!!_this.ngxPermissionsOnly) {
                _this.validateOnlyPermissions();
            }
            else {
                _this.handleAuthorisedPermission(_this.ngxPermissionsExceptThen || _this.ngxPermissionsThen || _this.templateRef);
            }
        }));
    };
    /**
     * @private
     * @return {?}
     */
    NgxPermissionsDirective.prototype.validateOnlyPermissions = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        // Validate permissions & store permission state
        this.getPermissions(this.ngxPermissionsOnly)
            .then((/**
         * @param {?} hasPermission
         * @return {?}
         */
        function (hasPermission) {
            if (hasPermission) {
                _this.handleAuthorisedPermission(_this.ngxPermissionsOnlyThen || _this.ngxPermissionsThen || _this.templateRef);
            }
            else {
                _this.handleUnauthorisedPermission(_this.ngxPermissionsOnlyElse || _this.ngxPermissionsElse);
            }
        }))
            .catch((/**
         * @return {?}
         */
        function () {
            _this.handleUnauthorisedPermission(_this.ngxPermissionsOnlyElse || _this.ngxPermissionsElse);
        }));
    };
    /**
     * @private
     * @param {?} template
     * @return {?}
     */
    NgxPermissionsDirective.prototype.handleUnauthorisedPermission = /**
     * @private
     * @param {?} template
     * @return {?}
     */
    function (template) {
        if (isBoolean(this.currentAuthorizedState) && !this.currentAuthorizedState)
            return;
        this.currentAuthorizedState = false;
        this.permissionsUnauthorized.emit(this.permissionsState);
        if (this.getUnAuthorizedStrategyInput()) {
            this.applyStrategyAccordingToStrategyType(this.getUnAuthorizedStrategyInput());
            return;
        }
        if (this.configurationService.onUnAuthorisedDefaultStrategy && !this.elseBlockDefined()) {
            this.applyStrategy(this.configurationService.onUnAuthorisedDefaultStrategy);
        }
        else {
            this.showTemplateBlockInView(template);
        }
    };
    /**
     * @private
     * @param {?} template
     * @return {?}
     */
    NgxPermissionsDirective.prototype.handleAuthorisedPermission = /**
     * @private
     * @param {?} template
     * @return {?}
     */
    function (template) {
        if (isBoolean(this.currentAuthorizedState) && this.currentAuthorizedState)
            return;
        this.currentAuthorizedState = true;
        this.permissionsAuthorized.emit(this.permissionsState);
        if (this.getAuthorizedStrategyInput()) {
            this.applyStrategyAccordingToStrategyType(this.getAuthorizedStrategyInput());
            return;
        }
        if (this.configurationService.onAuthorisedDefaultStrategy && !this.thenBlockDefined()) {
            this.applyStrategy(this.configurationService.onAuthorisedDefaultStrategy);
        }
        else {
            this.showTemplateBlockInView(template);
        }
    };
    /**
     * @private
     * @param {?} strategy
     * @return {?}
     */
    NgxPermissionsDirective.prototype.applyStrategyAccordingToStrategyType = /**
     * @private
     * @param {?} strategy
     * @return {?}
     */
    function (strategy) {
        if (isString(strategy)) {
            this.applyStrategy(strategy);
            return;
        }
        if (isFunction(strategy)) {
            this.showTemplateBlockInView(this.templateRef);
            ((/** @type {?} */ (strategy)))(this.templateRef, this.permissionsState);
            return;
        }
    };
    /**
     * @private
     * @param {?} template
     * @return {?}
     */
    NgxPermissionsDirective.prototype.showTemplateBlockInView = /**
     * @private
     * @param {?} template
     * @return {?}
     */
    function (template) {
        this.viewContainer.clear();
        if (!template) {
            return;
        }
        this.viewContainer.createEmbeddedView(template);
        this.changeDetector.markForCheck();
    };
    /**
     * @private
     * @return {?}
     */
    NgxPermissionsDirective.prototype.getAuthorisedTemplates = /**
     * @private
     * @return {?}
     */
    function () {
        return this.ngxPermissionsOnlyThen
            || this.ngxPermissionsExceptThen
            || this.ngxPermissionsThen
            || this.templateRef;
    };
    /**
     * @private
     * @return {?}
     */
    NgxPermissionsDirective.prototype.elseBlockDefined = /**
     * @private
     * @return {?}
     */
    function () {
        return !!this.ngxPermissionsExceptElse || !!this.ngxPermissionsElse;
    };
    /**
     * @private
     * @return {?}
     */
    NgxPermissionsDirective.prototype.thenBlockDefined = /**
     * @private
     * @return {?}
     */
    function () {
        return !!this.ngxPermissionsExceptThen || !!this.ngxPermissionsThen;
    };
    /**
     * @private
     * @return {?}
     */
    NgxPermissionsDirective.prototype.getAuthorizedStrategyInput = /**
     * @private
     * @return {?}
     */
    function () {
        return this.ngxPermissionsOnlyAuthorisedStrategy ||
            this.ngxPermissionsExceptAuthorisedStrategy ||
            this.ngxPermissionsAuthorisedStrategy;
    };
    /**
     * @private
     * @return {?}
     */
    NgxPermissionsDirective.prototype.getUnAuthorizedStrategyInput = /**
     * @private
     * @return {?}
     */
    function () {
        return this.ngxPermissionsOnlyUnauthorisedStrategy ||
            this.ngxPermissionsExceptUnauthorisedStrategy ||
            this.ngxPermissionsUnauthorisedStrategy;
    };
    /**
     * @private
     * @param {?} str
     * @return {?}
     */
    NgxPermissionsDirective.prototype.applyStrategy = /**
     * @private
     * @param {?} str
     * @return {?}
     */
    function (str) {
        if (str === NgxPermissionsPredefinedStrategies.SHOW) {
            this.showTemplateBlockInView(this.templateRef);
            return;
        }
        if (str === NgxPermissionsPredefinedStrategies.REMOVE) {
            this.viewContainer.clear();
            return;
        }
        /** @type {?} */
        var strategy = this.configurationService.getStrategy(str);
        this.showTemplateBlockInView(this.templateRef);
        strategy(this.templateRef, this.permissionsState);
    };
    /**
     * Check permission service against parameter "neddedPermissions"
     * then update this class property "permissionsState"
     *
     * @param neddedPermissions Sets the permissions/roles to check (i.e ngxPermissionsOnly)
     */
    /**
     * Check permission service against parameter "neddedPermissions"
     * then update this class property "permissionsState"
     *
     * @private
     * @param {?} neddedPermissions Sets the permissions/roles to check (i.e ngxPermissionsOnly)
     * @return {?}
     */
    NgxPermissionsDirective.prototype.getPermissions = /**
     * Check permission service against parameter "neddedPermissions"
     * then update this class property "permissionsState"
     *
     * @private
     * @param {?} neddedPermissions Sets the permissions/roles to check (i.e ngxPermissionsOnly)
     * @return {?}
     */
    function (neddedPermissions) {
        var _this = this;
        // Ensure we work with array
        /** @type {?} */
        var requestedPermissions = transformStringToArray(neddedPermissions)
        // Array of promises that request permission and roles service with "permission"
        ;
        // Array of promises that request permission and roles service with "permission"
        /** @type {?} */
        var promises = []
        // Reset "permissions state" directive class property
        ;
        // Reset "permissions state" directive class property
        this.permissionsState = {};
        if (isArray(requestedPermissions)) {
            requestedPermissions.forEach((/**
             * @param {?} value
             * @return {?}
             */
            function (value) {
                _this.permissionsState[value] = { hasPermission: false, hasRole: false };
                // Check if has "Permission"
                promises.push(_this.permissionsService.hasPermission(value)
                    .then((/**
                 * @param {?} hasPermission
                 * @return {?}
                 */
                function (hasPermission) {
                    _this.permissionsState[value].hasPermission = hasPermission;
                    return hasPermission;
                }))
                    .catch((/**
                 * @return {?}
                 */
                function () { return false; })));
                // Check if has "Role"
                promises.push(_this.rolesService.hasOnlyRoles(value)
                    .then((/**
                 * @param {?} hasPermission
                 * @return {?}
                 */
                function (hasPermission) {
                    _this.permissionsState[value].hasRole = hasPermission;
                    return hasPermission;
                }))
                    .catch((/**
                 * @return {?}
                 */
                function () { return false; })));
            }));
        }
        /**
         * Return result :
         * true : At least one of neededPermission exists in permission or role service (@see this.permissionsState to get a full detail on wich permission is true/false)
         * false : none of neededPermission exists in  permission or role service
        */
        return from(promises).pipe(mergeAll(), first((/**
         * @param {?} hasPermission
         * @return {?}
         */
        function (hasPermission) {
            return hasPermission === true;
        }), false), map((/**
         * @param {?} hasPermission
         * @return {?}
         */
        function (hasPermission) {
            return hasPermission;
        }))).toPromise().then((/**
         * @param {?} hasPermission
         * @return {?}
         */
        function (hasPermission) {
            return hasPermission;
        }));
    };
    NgxPermissionsDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[ngxPermissionsOnly],[ngxPermissionsExcept]'
                },] }
    ];
    /** @nocollapse */
    NgxPermissionsDirective.ctorParameters = function () { return [
        { type: NgxPermissionsService },
        { type: NgxPermissionsConfigurationService },
        { type: NgxRolesService },
        { type: ViewContainerRef },
        { type: ChangeDetectorRef },
        { type: TemplateRef }
    ]; };
    NgxPermissionsDirective.propDecorators = {
        ngxPermissionsOnly: [{ type: Input }],
        ngxPermissionsOnlyThen: [{ type: Input }],
        ngxPermissionsOnlyElse: [{ type: Input }],
        ngxPermissionsExcept: [{ type: Input }],
        ngxPermissionsExceptElse: [{ type: Input }],
        ngxPermissionsExceptThen: [{ type: Input }],
        ngxPermissionsThen: [{ type: Input }],
        ngxPermissionsElse: [{ type: Input }],
        ngxPermissionsOnlyAuthorisedStrategy: [{ type: Input }],
        ngxPermissionsOnlyUnauthorisedStrategy: [{ type: Input }],
        ngxPermissionsExceptUnauthorisedStrategy: [{ type: Input }],
        ngxPermissionsExceptAuthorisedStrategy: [{ type: Input }],
        ngxPermissionsUnauthorisedStrategy: [{ type: Input }],
        ngxPermissionsAuthorisedStrategy: [{ type: Input }],
        permissionsAuthorized: [{ type: Output }],
        permissionsUnauthorized: [{ type: Output }]
    };
    return NgxPermissionsDirective;
}());
export { NgxPermissionsDirective };
if (false) {
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsOnly;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsOnlyThen;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsOnlyElse;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsExcept;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsExceptElse;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsExceptThen;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsThen;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsElse;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsOnlyAuthorisedStrategy;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsOnlyUnauthorisedStrategy;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsExceptUnauthorisedStrategy;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsExceptAuthorisedStrategy;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsUnauthorisedStrategy;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsAuthorisedStrategy;
    /** @type {?} */
    NgxPermissionsDirective.prototype.permissionsAuthorized;
    /** @type {?} */
    NgxPermissionsDirective.prototype.permissionsUnauthorized;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.initPermissionSubscription;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.firstMergeUnusedRun;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.currentAuthorizedState;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.permissionsState;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.permissionsService;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.configurationService;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.rolesService;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.viewContainer;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.changeDetector;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.templateRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbnMuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXBlcm1pc3Npb25zLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZS9wZXJtaXNzaW9ucy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFDSCxpQkFBaUIsRUFDakIsU0FBUyxFQUNULFlBQVksRUFDWixLQUFLLEVBR0wsTUFBTSxFQUNOLFdBQVcsRUFDWCxnQkFBZ0IsRUFDbkIsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFFLEtBQUssRUFBZ0IsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pELE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFbEUsT0FBTyxFQUFFLGtDQUFrQyxFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDekYsT0FBTyxFQUFFLGtDQUFrQyxFQUFvQixNQUFNLGtDQUFrQyxDQUFDO0FBQ3hHLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsYUFBYSxFQUFFLHNCQUFzQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEcsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUsvQjtJQWtDSSxpQ0FDWSxrQkFBeUMsRUFDekMsb0JBQXdELEVBQ3hELFlBQTZCLEVBQzdCLGFBQStCLEVBQy9CLGNBQWlDLEVBQ2pDLFdBQTZCO1FBTDdCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBdUI7UUFDekMseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFvQztRQUN4RCxpQkFBWSxHQUFaLFlBQVksQ0FBaUI7UUFDN0Isa0JBQWEs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REFBOEM7O0lBRTlDLHVFQUF5RTs7SUFDekUseUVBQTJFOztJQUUzRSwyRUFBNkU7O0lBQzdFLHlFQUEyRTs7SUFFM0UscUVBQXVFOztJQUN2RSxtRUFBcUU7O0lBRXJFLHdEQUFzRTs7SUFDdEUsMERBQXdFOzs7OztJQUV4RSw2REFBaUQ7Ozs7O0lBRWpELHNEQUFnQzs7Ozs7SUFDaEMseURBQXdDOzs7OztJQUN4QyxtREFBMEM7Ozs7O0lBR3RDLHFEQUFpRDs7Ozs7SUFDakQsdURBQWdFOzs7OztJQUNoRSwrQ0FBcUM7Ozs7O0lBQ3JDLGdEQUF1Qzs7Ozs7SUFDdkMsaURBQXlDOzs7OztJQUN6Qyw4Q0FBcUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gICAgQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgICBEaXJlY3RpdmUsXHJcbiAgICBFdmVudEVtaXR0ZXIsXHJcbiAgICBJbnB1dCwgT25DaGFuZ2VzLFxyXG4gICAgT25EZXN0cm95LFxyXG4gICAgT25Jbml0LFxyXG4gICAgT3V0cHV0LCBTaW1wbGVDaGFuZ2VzLFxyXG4gICAgVGVtcGxhdGVSZWYsXHJcbiAgICBWaWV3Q29udGFpbmVyUmVmXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG5pbXBvcnQgeyBtZXJnZSwgU3Vic2NyaXB0aW9uLCBmcm9tIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHNraXAsIHRha2UsIG1lcmdlQWxsLCBmaXJzdCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuaW1wb3J0IHsgTmd4UGVybWlzc2lvbnNQcmVkZWZpbmVkU3RyYXRlZ2llcyB9IGZyb20gJy4uL2VudW1zL3ByZWRlZmluZWQtc3RyYXRlZ2llcy5lbnVtJztcclxuaW1wb3J0IHsgTmd4UGVybWlzc2lvbnNDb25maWd1cmF0aW9uU2VydmljZSwgU3RyYXRlZ3lGdW5jdGlvbiB9IGZyb20gJy4uL3NlcnZpY2UvY29uZmlndXJhdGlvbi5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTmd4UGVybWlzc2lvbnNTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZS9wZXJtaXNzaW9ucy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTmd4Um9sZXNTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZS9yb2xlcy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgaXNCb29sZWFuLCBpc0Z1bmN0aW9uLCBpc1N0cmluZywgbm90RW1wdHlWYWx1ZSwgdHJhbnNmb3JtU3RyaW5nVG9BcnJheSB9IGZyb20gJy4uL3V0aWxzL3V0aWxzJztcclxuaW1wb3J0IHsgaXNBcnJheSB9IGZyb20gJ3V0aWwnO1xyXG5cclxuLy8gU3RydWN0LiB0byBrZWVwIGRpcmVjdGl2ZSB0cmFjayBvZiBwZXJtaXNzaW9ucyBzdGF0ZXNcclxuZXhwb3J0IHR5cGUgUGVybWlzc2lvblN0YXRlID0geyBbcGVybWlzc2lvbjogc3RyaW5nXTogeyBoYXNQZXJtaXNzaW9uOiBib29sZWFuLCBoYXNSb2xlOiBib29sZWFuIH0gfVxyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogJ1tuZ3hQZXJtaXNzaW9uc09ubHldLFtuZ3hQZXJtaXNzaW9uc0V4Y2VwdF0nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBOZ3hQZXJtaXNzaW9uc0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95LCBPbkNoYW5nZXMge1xyXG5cclxuICAgIEBJbnB1dCgpIG5neFBlcm1pc3Npb25zT25seTogc3RyaW5nIHwgc3RyaW5nW107XHJcbiAgICBASW5wdXQoKSBuZ3hQZXJtaXNzaW9uc09ubHlUaGVuOiBUZW1wbGF0ZVJlZjxhbnk+O1xyXG4gICAgQElucHV0KCkgbmd4UGVybWlzc2lvbnNPbmx5RWxzZTogVGVtcGxhdGVSZWY8YW55PjtcclxuXHJcbiAgICBASW5wdXQoKSBuZ3hQZXJtaXNzaW9uc0V4Y2VwdDogc3RyaW5nIHwgc3RyaW5nW107XHJcbiAgICBASW5wdXQoKSBuZ3hQZXJtaXNzaW9uc0V4Y2VwdEVsc2U6IFRlbXBsYXRlUmVmPGFueT47XHJcbiAgICBASW5wdXQoKSBuZ3hQZXJtaXNzaW9uc0V4Y2VwdFRoZW46IFRlbXBsYXRlUmVmPGFueT47XHJcblxyXG4gICAgQElucHV0KCkgbmd4UGVybWlzc2lvbnNUaGVuOiBUZW1wbGF0ZVJlZjxhbnk+O1xyXG4gICAgQElucHV0KCkgbmd4UGVybWlzc2lvbnNFbHNlOiBUZW1wbGF0ZVJlZjxhbnk+O1xyXG5cclxuICAgIEBJbnB1dCgpIG5neFBlcm1pc3Npb25zT25seUF1dGhvcmlzZWRTdHJhdGVneTogc3RyaW5nIHwgU3RyYXRlZ3lGdW5jdGlvbjtcclxuICAgIEBJbnB1dCgpIG5neFBlcm1pc3Npb25zT25seVVuYXV0aG9yaXNlZFN0cmF0ZWd5OiBzdHJpbmcgfCBTdHJhdGVneUZ1bmN0aW9uO1xyXG5cclxuICAgIEBJbnB1dCgpIG5neFBlcm1pc3Npb25zRXhjZXB0VW5hdXRob3Jpc2VkU3RyYXRlZ3k6IHN0cmluZyB8IFN0cmF0ZWd5RnVuY3Rpb247XHJcbiAgICBASW5wdXQoKSBuZ3hQZXJtaXNzaW9uc0V4Y2VwdEF1dGhvcmlzZWRTdHJhdGVneTogc3RyaW5nIHwgU3RyYXRlZ3lGdW5jdGlvbjtcclxuXHJcbiAgICBASW5wdXQoKSBuZ3hQZXJtaXNzaW9uc1VuYXV0aG9yaXNlZFN0cmF0ZWd5OiBzdHJpbmcgfCBTdHJhdGVneUZ1bmN0aW9uO1xyXG4gICAgQElucHV0KCkgbmd4UGVybWlzc2lvbnNBdXRob3Jpc2VkU3RyYXRlZ3k6IHN0cmluZyB8IFN0cmF0ZWd5RnVuY3Rpb247XHJcblxyXG4gICAgQE91dHB1dCgpIHBlcm1pc3Npb25zQXV0aG9yaXplZCA9IG5ldyBFdmVudEVtaXR0ZXI8UGVybWlzc2lvblN0YXRlPigpO1xyXG4gICAgQE91dHB1dCgpIHBlcm1pc3Npb25zVW5hdXRob3JpemVkID0gbmV3IEV2ZW50RW1pdHRlcjxQZXJtaXNzaW9uU3RhdGU+KCk7XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0UGVybWlzc2lvblN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xyXG4gICAgLy8gc2tpcCBmaXJzdCBydW4gY2F1c2UgbWVyZ2Ugd2lsbCBmaXJlIHR3aWNlXHJcbiAgICBwcml2YXRlIGZpcnN0TWVyZ2VVbnVzZWRSdW4gPSAxO1xyXG4gICAgcHJpdmF0ZSBjdXJyZW50QXV0aG9yaXplZFN0YXRlOiBib29sZWFuO1xyXG4gICAgcHJpdmF0ZSBwZXJtaXNzaW9uc1N0YXRlOiBQZXJtaXNzaW9uU3RhdGU7XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSBwZXJtaXNzaW9uc1NlcnZpY2U6IE5neFBlcm1pc3Npb25zU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIGNvbmZpZ3VyYXRpb25TZXJ2aWNlOiBOZ3hQZXJtaXNzaW9uc0NvbmZpZ3VyYXRpb25TZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgcm9sZXNTZXJ2aWNlOiBOZ3hSb2xlc1NlcnZpY2UsXHJcbiAgICAgICAgcHJpdmF0ZSB2aWV3Q29udGFpbmVyOiBWaWV3Q29udGFpbmVyUmVmLFxyXG4gICAgICAgIHByaXZhdGUgY2hhbmdlRGV0ZWN0b3I6IENoYW5nZURldGVjdG9yUmVmLFxyXG4gICAgICAgIHByaXZhdGUgdGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPGFueT5cclxuICAgICkge1xyXG4gICAgICAgIHRoaXMucGVybWlzc2lvbnNTdGF0ZSA9IHt9O1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMudmlld0NvbnRhaW5lci5jbGVhcigpO1xyXG4gICAgICAgIHRoaXMuaW5pdFBlcm1pc3Npb25TdWJzY3JpcHRpb24gPSB0aGlzLnZhbGlkYXRlRXhjZXB0T25seVBlcm1pc3Npb25zKCk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBvbmx5Q2hhbmdlcyA9IGNoYW5nZXNbJ25neFBlcm1pc3Npb25zT25seSddO1xyXG4gICAgICAgIGNvbnN0IGV4Y2VwdENoYW5nZXMgPSBjaGFuZ2VzWyduZ3hQZXJtaXNzaW9uc0V4Y2VwdCddO1xyXG4gICAgICAgIGlmIChvbmx5Q2hhbmdlcyB8fCBleGNlcHRDaGFuZ2VzKSB7XHJcbiAgICAgICAgICAgIC8vIER1ZSB0byBidWcgd2hlbiB5b3UgcGFzcyBlbXB0eSBhcnJheVxyXG4gICAgICAgICAgICBpZiAob25seUNoYW5nZXMgJiYgb25seUNoYW5nZXMuZmlyc3RDaGFuZ2UpIHJldHVybjtcclxuICAgICAgICAgICAgaWYgKGV4Y2VwdENoYW5nZXMgJiYgZXhjZXB0Q2hhbmdlcy5maXJzdENoYW5nZSkgcmV0dXJuO1xyXG5cclxuICAgICAgICAgICAgbWVyZ2UodGhpcy5wZXJtaXNzaW9uc1NlcnZpY2UucGVybWlzc2lvbnMkLCB0aGlzLnJvbGVzU2VydmljZS5yb2xlcyQpXHJcbiAgICAgICAgICAgICAgICAucGlwZShza2lwKHRoaXMuZmlyc3RNZXJnZVVudXNlZFJ1biksIHRha2UoMSkpXHJcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobm90RW1wdHlWYWx1ZSh0aGlzLm5neFBlcm1pc3Npb25zRXhjZXB0KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZhbGlkYXRlRXhjZXB0QW5kT25seVBlcm1pc3Npb25zKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChub3RFbXB0eVZhbHVlKHRoaXMubmd4UGVybWlzc2lvbnNPbmx5KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZhbGlkYXRlT25seVBlcm1pc3Npb25zKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQXV0aG9yaXNlZFBlcm1pc3Npb24odGhpcy5nZXRBdXRob3Jpc2VkVGVtcGxhdGVzKCkpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLmluaXRQZXJtaXNzaW9uU3Vic2NyaXB0aW9uKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdFBlcm1pc3Npb25TdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB2YWxpZGF0ZUV4Y2VwdE9ubHlQZXJtaXNzaW9ucygpOiBTdWJzY3JpcHRpb24ge1xyXG4gICAgICAgIHJldHVybiBtZXJnZSh0aGlzLnBlcm1pc3Npb25zU2VydmljZS5wZXJtaXNzaW9ucyQsIHRoaXMucm9sZXNTZXJ2aWNlLnJvbGVzJClcclxuICAgICAgICAgICAgLnBpcGUoc2tpcCh0aGlzLmZpcnN0TWVyZ2VVbnVzZWRSdW4pKVxyXG4gICAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChub3RFbXB0eVZhbHVlKHRoaXMubmd4UGVybWlzc2lvbnNFeGNlcHQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy52YWxpZGF0ZUV4Y2VwdEFuZE9ubHlQZXJtaXNzaW9ucygpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAobm90RW1wdHlWYWx1ZSh0aGlzLm5neFBlcm1pc3Npb25zT25seSkpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnZhbGlkYXRlT25seVBlcm1pc3Npb25zKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVBdXRob3Jpc2VkUGVybWlzc2lvbih0aGlzLmdldEF1dGhvcmlzZWRUZW1wbGF0ZXMoKSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdmFsaWRhdGVFeGNlcHRBbmRPbmx5UGVybWlzc2lvbnMoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5nZXRQZXJtaXNzaW9ucyh0aGlzLm5neFBlcm1pc3Npb25zRXhjZXB0KVxyXG4gICAgICAgICAgICAudGhlbigoaGFzUGVybWlzc2lvbjogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGhhc1Blcm1pc3Npb24pIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVVuYXV0aG9yaXNlZFBlcm1pc3Npb24odGhpcy5uZ3hQZXJtaXNzaW9uc0V4Y2VwdEVsc2UgfHwgdGhpcy5uZ3hQZXJtaXNzaW9uc0Vsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICghIXRoaXMubmd4UGVybWlzc2lvbnNPbmx5KSB0aHJvdyBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQXV0aG9yaXNlZFBlcm1pc3Npb24odGhpcy5uZ3hQZXJtaXNzaW9uc0V4Y2VwdFRoZW4gfHwgdGhpcy5uZ3hQZXJtaXNzaW9uc1RoZW4gfHwgdGhpcy50ZW1wbGF0ZVJlZik7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoISF0aGlzLm5neFBlcm1pc3Npb25zT25seSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudmFsaWRhdGVPbmx5UGVybWlzc2lvbnMoKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVBdXRob3Jpc2VkUGVybWlzc2lvbih0aGlzLm5neFBlcm1pc3Npb25zRXhjZXB0VGhlbiB8fCB0aGlzLm5neFBlcm1pc3Npb25zVGhlbiB8fCB0aGlzLnRlbXBsYXRlUmVmKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB2YWxpZGF0ZU9ubHlQZXJtaXNzaW9ucygpOiB2b2lkIHtcclxuICAgICAgICAvLyBWYWxpZGF0ZSBwZXJtaXNzaW9ucyAmIHN0b3JlIHBlcm1pc3Npb24gc3RhdGVcclxuICAgICAgICB0aGlzLmdldFBlcm1pc3Npb25zKHRoaXMubmd4UGVybWlzc2lvbnNPbmx5KVxyXG4gICAgICAgICAgICAudGhlbigoaGFzUGVybWlzc2lvbjogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGhhc1Blcm1pc3Npb24pIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUF1dGhvcmlzZWRQZXJtaXNzaW9uKHRoaXMubmd4UGVybWlzc2lvbnNPbmx5VGhlbiB8fCB0aGlzLm5neFBlcm1pc3Npb25zVGhlbiB8fCB0aGlzLnRlbXBsYXRlUmVmKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVVbmF1dGhvcmlzZWRQZXJtaXNzaW9uKHRoaXMubmd4UGVybWlzc2lvbnNPbmx5RWxzZSB8fCB0aGlzLm5neFBlcm1pc3Npb25zRWxzZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVVuYXV0aG9yaXNlZFBlcm1pc3Npb24odGhpcy5uZ3hQZXJtaXNzaW9uc09ubHlFbHNlIHx8IHRoaXMubmd4UGVybWlzc2lvbnNFbHNlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBoYW5kbGVVbmF1dGhvcmlzZWRQZXJtaXNzaW9uKHRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+KTogdm9pZCB7XHJcbiAgICAgICAgaWYgKGlzQm9vbGVhbih0aGlzLmN1cnJlbnRBdXRob3JpemVkU3RhdGUpICYmICF0aGlzLmN1cnJlbnRBdXRob3JpemVkU3RhdGUpIHJldHVybjtcclxuXHJcbiAgICAgICAgdGhpcy5jdXJyZW50QXV0aG9yaXplZFN0YXRlID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5wZXJtaXNzaW9uc1VuYXV0aG9yaXplZC5lbWl0KHRoaXMucGVybWlzc2lvbnNTdGF0ZSk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmdldFVuQXV0aG9yaXplZFN0cmF0ZWd5SW5wdXQoKSkge1xyXG4gICAgICAgICAgICB0aGlzLmFwcGx5U3RyYXRlZ3lBY2NvcmRpbmdUb1N0cmF0ZWd5VHlwZSh0aGlzLmdldFVuQXV0aG9yaXplZFN0cmF0ZWd5SW5wdXQoKSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmNvbmZpZ3VyYXRpb25TZXJ2aWNlLm9uVW5BdXRob3Jpc2VkRGVmYXVsdFN0cmF0ZWd5ICYmICF0aGlzLmVsc2VCbG9ja0RlZmluZWQoKSkge1xyXG4gICAgICAgICAgICB0aGlzLmFwcGx5U3RyYXRlZ3kodGhpcy5jb25maWd1cmF0aW9uU2VydmljZS5vblVuQXV0aG9yaXNlZERlZmF1bHRTdHJhdGVneSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5zaG93VGVtcGxhdGVCbG9ja0luVmlldyh0ZW1wbGF0ZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGhhbmRsZUF1dGhvcmlzZWRQZXJtaXNzaW9uKHRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+KTogdm9pZCB7XHJcbiAgICAgICAgaWYgKGlzQm9vbGVhbih0aGlzLmN1cnJlbnRBdXRob3JpemVkU3RhdGUpICYmIHRoaXMuY3VycmVudEF1dGhvcml6ZWRTdGF0ZSkgcmV0dXJuO1xyXG5cclxuICAgICAgICB0aGlzLmN1cnJlbnRBdXRob3JpemVkU3RhdGUgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMucGVybWlzc2lvbnNBdXRob3JpemVkLmVtaXQodGhpcy5wZXJtaXNzaW9uc1N0YXRlKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuZ2V0QXV0aG9yaXplZFN0cmF0ZWd5SW5wdXQoKSkge1xyXG4gICAgICAgICAgICB0aGlzLmFwcGx5U3RyYXRlZ3lBY2NvcmRpbmdUb1N0cmF0ZWd5VHlwZSh0aGlzLmdldEF1dGhvcml6ZWRTdHJhdGVneUlucHV0KCkpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5jb25maWd1cmF0aW9uU2VydmljZS5vbkF1dGhvcmlzZWREZWZhdWx0U3RyYXRlZ3kgJiYgIXRoaXMudGhlbkJsb2NrRGVmaW5lZCgpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYXBwbHlTdHJhdGVneSh0aGlzLmNvbmZpZ3VyYXRpb25TZXJ2aWNlLm9uQXV0aG9yaXNlZERlZmF1bHRTdHJhdGVneSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5zaG93VGVtcGxhdGVCbG9ja0luVmlldyh0ZW1wbGF0ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYXBwbHlTdHJhdGVneUFjY29yZGluZ1RvU3RyYXRlZ3lUeXBlKHN0cmF0ZWd5OiBzdHJpbmcgfCBGdW5jdGlvbik6IHZvaWQge1xyXG4gICAgICAgIGlmIChpc1N0cmluZyhzdHJhdGVneSkpIHtcclxuICAgICAgICAgICAgdGhpcy5hcHBseVN0cmF0ZWd5KHN0cmF0ZWd5KTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGlzRnVuY3Rpb24oc3RyYXRlZ3kpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2hvd1RlbXBsYXRlQmxvY2tJblZpZXcodGhpcy50ZW1wbGF0ZVJlZik7XHJcbiAgICAgICAgICAgIChzdHJhdGVneSBhcyBGdW5jdGlvbikodGhpcy50ZW1wbGF0ZVJlZiwgdGhpcy5wZXJtaXNzaW9uc1N0YXRlKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNob3dUZW1wbGF0ZUJsb2NrSW5WaWV3KHRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+KTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy52aWV3Q29udGFpbmVyLmNsZWFyKCk7XHJcbiAgICAgICAgaWYgKCF0ZW1wbGF0ZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnZpZXdDb250YWluZXIuY3JlYXRlRW1iZWRkZWRWaWV3KHRlbXBsYXRlKTtcclxuICAgICAgICB0aGlzLmNoYW5nZURldGVjdG9yLm1hcmtGb3JDaGVjaygpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0QXV0aG9yaXNlZFRlbXBsYXRlcygpOiBUZW1wbGF0ZVJlZjxhbnk+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5uZ3hQZXJtaXNzaW9uc09ubHlUaGVuXHJcbiAgICAgICAgICAgIHx8IHRoaXMubmd4UGVybWlzc2lvbnNFeGNlcHRUaGVuXHJcbiAgICAgICAgICAgIHx8IHRoaXMubmd4UGVybWlzc2lvbnNUaGVuXHJcbiAgICAgICAgICAgIHx8IHRoaXMudGVtcGxhdGVSZWY7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBlbHNlQmxvY2tEZWZpbmVkKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiAhIXRoaXMubmd4UGVybWlzc2lvbnNFeGNlcHRFbHNlIHx8ICEhdGhpcy5uZ3hQZXJtaXNzaW9uc0Vsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB0aGVuQmxvY2tEZWZpbmVkKCkge1xyXG4gICAgICAgIHJldHVybiAhIXRoaXMubmd4UGVybWlzc2lvbnNFeGNlcHRUaGVuIHx8ICEhdGhpcy5uZ3hQZXJtaXNzaW9uc1RoZW47XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRBdXRob3JpemVkU3RyYXRlZ3lJbnB1dCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5uZ3hQZXJtaXNzaW9uc09ubHlBdXRob3Jpc2VkU3RyYXRlZ3kgfHxcclxuICAgICAgICAgICAgdGhpcy5uZ3hQZXJtaXNzaW9uc0V4Y2VwdEF1dGhvcmlzZWRTdHJhdGVneSB8fFxyXG4gICAgICAgICAgICB0aGlzLm5neFBlcm1pc3Npb25zQXV0aG9yaXNlZFN0cmF0ZWd5O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0VW5BdXRob3JpemVkU3RyYXRlZ3lJbnB1dCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5uZ3hQZXJtaXNzaW9uc09ubHlVbmF1dGhvcmlzZWRTdHJhdGVneSB8fFxyXG4gICAgICAgICAgICB0aGlzLm5neFBlcm1pc3Npb25zRXhjZXB0VW5hdXRob3Jpc2VkU3RyYXRlZ3kgfHxcclxuICAgICAgICAgICAgdGhpcy5uZ3hQZXJtaXNzaW9uc1VuYXV0aG9yaXNlZFN0cmF0ZWd5O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYXBwbHlTdHJhdGVneShzdHI6IGFueSkge1xyXG4gICAgICAgIGlmIChzdHIgPT09IE5neFBlcm1pc3Npb25zUHJlZGVmaW5lZFN0cmF0ZWdpZXMuU0hPVykge1xyXG4gICAgICAgICAgICB0aGlzLnNob3dUZW1wbGF0ZUJsb2NrSW5WaWV3KHRoaXMudGVtcGxhdGVSZWYpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoc3RyID09PSBOZ3hQZXJtaXNzaW9uc1ByZWRlZmluZWRTdHJhdGVnaWVzLlJFTU9WRSkge1xyXG4gICAgICAgICAgICB0aGlzLnZpZXdDb250YWluZXIuY2xlYXIoKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBzdHJhdGVneSA9IHRoaXMuY29uZmlndXJhdGlvblNlcnZpY2UuZ2V0U3RyYXRlZ3koc3RyKTtcclxuICAgICAgICB0aGlzLnNob3dUZW1wbGF0ZUJsb2NrSW5WaWV3KHRoaXMudGVtcGxhdGVSZWYpO1xyXG5cclxuICAgICAgICBzdHJhdGVneSh0aGlzLnRlbXBsYXRlUmVmLCB0aGlzLnBlcm1pc3Npb25zU3RhdGUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ2hlY2sgcGVybWlzc2lvbiBzZXJ2aWNlIGFnYWluc3QgcGFyYW1ldGVyIFwibmVkZGVkUGVybWlzc2lvbnNcIlxyXG4gICAgICogdGhlbiB1cGRhdGUgdGhpcyBjbGFzcyBwcm9wZXJ0eSBcInBlcm1pc3Npb25zU3RhdGVcIlxyXG4gICAgICogXHJcbiAgICAgKiBAcGFyYW0gbmVkZGVkUGVybWlzc2lvbnMgU2V0cyB0aGUgcGVybWlzc2lvbnMvcm9sZXMgdG8gY2hlY2sgKGkuZSBuZ3hQZXJtaXNzaW9uc09ubHkpXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgZ2V0UGVybWlzc2lvbnMobmVkZGVkUGVybWlzc2lvbnM6IHN0cmluZyB8IHN0cmluZ1tdKTogUHJvbWlzZTxib29sZWFuPiB7XHJcblxyXG4gICAgICAgIC8vIEVuc3VyZSB3ZSB3b3JrIHdpdGggYXJyYXlcclxuICAgICAgICB2YXIgcmVxdWVzdGVkUGVybWlzc2lvbnM6IEFycmF5PHN0cmluZz4gPSB0cmFuc2Zvcm1TdHJpbmdUb0FycmF5KG5lZGRlZFBlcm1pc3Npb25zKVxyXG5cclxuICAgICAgICAvLyBBcnJheSBvZiBwcm9taXNlcyB0aGF0IHJlcXVlc3QgcGVybWlzc2lvbiBhbmQgcm9sZXMgc2VydmljZSB3aXRoIFwicGVybWlzc2lvblwiXHJcbiAgICAgICAgdmFyIHByb21pc2VzOiBQcm9taXNlPGJvb2xlYW4+W10gPSBbXVxyXG5cclxuICAgICAgICAvLyBSZXNldCBcInBlcm1pc3Npb25zIHN0YXRlXCIgZGlyZWN0aXZlIGNsYXNzIHByb3BlcnR5XHJcbiAgICAgICAgdGhpcy5wZXJtaXNzaW9uc1N0YXRlID0ge31cclxuXHJcbiAgICAgICAgaWYgKGlzQXJyYXkocmVxdWVzdGVkUGVybWlzc2lvbnMpKSB7XHJcbiAgICAgICAgICAgIHJlcXVlc3RlZFBlcm1pc3Npb25zLmZvckVhY2goKHZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBlcm1pc3Npb25zU3RhdGVbdmFsdWVdID0geyBoYXNQZXJtaXNzaW9uOiBmYWxzZSwgaGFzUm9sZTogZmFsc2UgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGhhcyBcIlBlcm1pc3Npb25cIlxyXG4gICAgICAgICAgICAgICAgcHJvbWlzZXMucHVzaChcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcm1pc3Npb25zU2VydmljZS5oYXNQZXJtaXNzaW9uKHZhbHVlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoaGFzUGVybWlzc2lvbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJtaXNzaW9uc1N0YXRlW3ZhbHVlXS5oYXNQZXJtaXNzaW9uID0gaGFzUGVybWlzc2lvblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhhc1Blcm1pc3Npb247XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoKSA9PiBmYWxzZSlcclxuICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGhhcyBcIlJvbGVcIlxyXG4gICAgICAgICAgICAgICAgcHJvbWlzZXMucHVzaChcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJvbGVzU2VydmljZS5oYXNPbmx5Um9sZXModmFsdWUpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChoYXNQZXJtaXNzaW9uKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcm1pc3Npb25zU3RhdGVbdmFsdWVdLmhhc1JvbGUgPSBoYXNQZXJtaXNzaW9uXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGFzUGVybWlzc2lvbjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKCgpID0+IGZhbHNlKVxyXG4gICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLyoqIFxyXG4gICAgICAgICAqIFJldHVybiByZXN1bHQgOlxyXG4gICAgICAgICAqIHRydWUgOiBBdCBsZWFzdCBvbmUgb2YgbmVlZGVkUGVybWlzc2lvbiBleGlzdHMgaW4gcGVybWlzc2lvbiBvciByb2xlIHNlcnZpY2UgKEBzZWUgdGhpcy5wZXJtaXNzaW9uc1N0YXRlIHRvIGdldCBhIGZ1bGwgZGV0YWlsIG9uIHdpY2ggcGVybWlzc2lvbiBpcyB0cnVlL2ZhbHNlKVxyXG4gICAgICAgICAqIGZhbHNlIDogbm9uZSBvZiBuZWVkZWRQZXJtaXNzaW9uIGV4aXN0cyBpbiAgcGVybWlzc2lvbiBvciByb2xlIHNlcnZpY2VcclxuICAgICAgICAqL1xyXG4gICAgICAgIHJldHVybiBmcm9tKHByb21pc2VzKS5waXBlKFxyXG4gICAgICAgICAgICBtZXJnZUFsbCgpLFxyXG4gICAgICAgICAgICBmaXJzdCgoaGFzUGVybWlzc2lvbjogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGhhc1Blcm1pc3Npb24gPT09IHRydWU7XHJcbiAgICAgICAgICAgIH0sIGZhbHNlKSxcclxuICAgICAgICAgICAgbWFwKChoYXNQZXJtaXNzaW9uKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaGFzUGVybWlzc2lvbjtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICApLnRvUHJvbWlzZSgpLnRoZW4oKGhhc1Blcm1pc3Npb246IGJvb2xlYW4pID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGhhc1Blcm1pc3Npb25cclxuICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG4iXX0=