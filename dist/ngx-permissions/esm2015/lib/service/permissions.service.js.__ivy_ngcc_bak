/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Inject, Injectable, InjectionToken } from '@angular/core';
import { BehaviorSubject, from, of } from 'rxjs';
import { catchError, first, map, mergeAll, switchMap } from 'rxjs/operators';
import { NgxPermissionsStore } from '../store/permissions.store';
import { isBoolean, isFunction, transformStringToArray } from '../utils/utils';
/** @type {?} */
export const USE_PERMISSIONS_STORE = new InjectionToken('USE_PERMISSIONS_STORE');
export class NgxPermissionsService {
    /**
     * @param {?=} isolate
     * @param {?=} permissionsStore
     */
    constructor(isolate = false, permissionsStore) {
        this.isolate = isolate;
        this.permissionsStore = permissionsStore;
        this.permissionsSource = isolate ? new BehaviorSubject({}) : permissionsStore.permissionsSource;
        this.permissions$ = this.permissionsSource.asObservable();
    }
    /**
     * Remove all permissions from permissions source
     * @return {?}
     */
    flushPermissions() {
        this.permissionsSource.next({});
    }
    /**
     * @param {?} permission
     * @return {?}
     */
    hasPermission(permission) {
        if (!permission || (Array.isArray(permission) && permission.length === 0)) {
            return Promise.resolve(true);
        }
        permission = transformStringToArray(permission);
        return this.hasArrayPermission(permission);
    }
    /**
     * @param {?} permissions
     * @param {?=} validationFunction
     * @return {?}
     */
    loadPermissions(permissions, validationFunction) {
        /** @type {?} */
        const newPermissions = permissions.reduce((/**
         * @param {?} source
         * @param {?} p
         * @return {?}
         */
        (source, p) => this.reducePermission(source, p, validationFunction)), {});
        this.permissionsSource.next(newPermissions);
    }
    /**
     * @param {?} permission
     * @param {?=} validationFunction
     * @return {?}
     */
    addPermission(permission, validationFunction) {
        if (Array.isArray(permission)) {
            /** @type {?} */
            const permissions = permission.reduce((/**
             * @param {?} source
             * @param {?} p
             * @return {?}
             */
            (source, p) => this.reducePermission(source, p, validationFunction)), this.permissionsSource.value);
            this.permissionsSource.next(permissions);
        }
        else {
            /** @type {?} */
            const permissions = this.reducePermission(this.permissionsSource.value, permission, validationFunction);
            this.permissionsSource.next(permissions);
        }
    }
    /**
     * @param {?} permissionName
     * @return {?}
     */
    removePermission(permissionName) {
        /** @type {?} */
        const permissions = Object.assign({}, this.permissionsSource.value);
        delete permissions[permissionName];
        this.permissionsSource.next(permissions);
    }
    /**
     * @param {?} name
     * @return {?}
     */
    getPermission(name) {
        return this.permissionsSource.value[name];
    }
    /**
     * @return {?}
     */
    getPermissions() {
        return this.permissionsSource.value;
    }
    /**
     * @private
     * @param {?} source
     * @param {?} name
     * @param {?=} validationFunction
     * @return {?}
     */
    reducePermission(source, name, validationFunction) {
        if (!!validationFunction && isFunction(validationFunction)) {
            return Object.assign({}, source, { [name]: { name, validationFunction } });
        }
        else {
            return Object.assign({}, source, { [name]: { name } });
        }
    }
    /**
     * @private
     * @param {?} permissions
     * @return {?}
     */
    hasArrayPermission(permissions) {
        /** @type {?} */
        const promises = permissions.map((/**
         * @param {?} key
         * @return {?}
         */
        (key) => {
            if (this.hasPermissionValidationFunction(key)) {
                /** @type {?} */
                const immutableValue = Object.assign({}, this.permissionsSource.value);
                /** @type {?} */
                const validationFunction = (/** @type {?} */ (this.permissionsSource.value[key].validationFunction));
                return of(null).pipe(map((/**
                 * @return {?}
                 */
                () => {
                    return validationFunction(key, immutableValue);
                })), switchMap((/**
                 * @param {?} promise
                 * @return {?}
                 */
                (promise) => {
                    /** @type {?} */
                    var b = isBoolean(promise);
                    if (b) {
                        return of((/** @type {?} */ (promise)));
                    }
                    else {
                        return (/** @type {?} */ (promise));
                    }
                })), catchError((/**
                 * @return {?}
                 */
                () => of(false))));
            }
            // check for name of the permission if there is no validation function
            return of(!!this.permissionsSource.value[key]);
        }));
        return from(promises).pipe(mergeAll(), first((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            /** @type {?} */
            const r = data !== false;
            return r;
        }), false), map((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            /** @type {?} */
            const r = data === false ? false : true;
            return r;
        }))).toPromise().then((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            return data;
        }));
    }
    /**
     * @private
     * @param {?} key
     * @return {?}
     */
    hasPermissionValidationFunction(key) {
        return !!this.permissionsSource.value[key] &&
            !!this.permissionsSource.value[key].validationFunction &&
            isFunction(this.permissionsSource.value[key].validationFunction);
    }
}
NgxPermissionsService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
NgxPermissionsService.ctorParameters = () => [
    { type: Boolean, decorators: [{ type: Inject, args: [USE_PERMISSIONS_STORE,] }] },
    { type: NgxPermissionsStore }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsService.prototype.permissionsSource;
    /** @type {?} */
    NgxPermissionsService.prototype.permissions$;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsService.prototype.isolate;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsService.prototype.permissionsStore;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbnMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1wZXJtaXNzaW9ucy8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlL3Blcm1pc3Npb25zLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVuRSxPQUFPLEVBQUUsZUFBZSxFQUFFLElBQUksRUFBK0IsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzlFLE9BQU8sRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFZLE1BQU0sZ0JBQWdCLENBQUM7QUFHdkYsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFFakUsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7QUFJL0UsTUFBTSxPQUFPLHFCQUFxQixHQUFHLElBQUksY0FBYyxDQUFDLHVCQUF1QixDQUFDO0FBR2hGLE1BQU0sT0FBTyxxQkFBcUI7Ozs7O0lBSzlCLFlBQzJDLFVBQW1CLEtBQUssRUFDdkQsZ0JBQXFDO1FBRE4sWUFBTyxHQUFQLE9BQU8sQ0FBaUI7UUFDdkQscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFxQjtRQUU3QyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLGVBQWUsQ0FBdUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLGlCQUFpQixDQUFDO1FBQ3RILElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFlBQVksRUFBRSxDQUFDO0lBQzlELENBQUM7Ozs7O0lBS00sZ0JBQWdCO1FBQ25CLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFD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Q0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUk7WUFDdkMsT0FBTyxDQUFDLENBQUM7UUFDYixDQUFDLEVBQUMsQ0FDTCxDQUFDLFNBQVMsRUFBRSxDQUFDLElBQUk7Ozs7UUFBQyxDQUFDLElBQVMsRUFBRSxFQUFFO1lBQzdCLE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUMsRUFBQyxDQUFDO0lBQ1AsQ0FBQzs7Ozs7O0lBRU8sK0JBQStCLENBQUMsR0FBVztRQUMvQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQztZQUN0QyxDQUFDLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxrQkFBa0I7WUFDdEQsVUFBVSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUN6RSxDQUFDOzs7WUFwSUosVUFBVTs7OzswQ0FPRixNQUFNLFNBQUMscUJBQXFCO1lBZjVCLG1CQUFtQjs7Ozs7OztJQVd4QixrREFBaUU7O0lBQ2pFLDZDQUFzRDs7Ozs7SUFHbEQsd0NBQStEOzs7OztJQUMvRCxpREFBNkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdGlvblRva2VuIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGZyb20sIE9ic2VydmFibGUsIE9ic2VydmFibGVJbnB1dCwgb2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgY2F0Y2hFcnJvciwgZmlyc3QsIG1hcCwgbWVyZ2VBbGwsIHN3aXRjaE1hcCwgbWVyZ2VNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBOZ3hQZXJtaXNzaW9uIH0gZnJvbSAnLi4vbW9kZWwvcGVybWlzc2lvbi5tb2RlbCc7XHJcbmltcG9ydCB7IE5neFBlcm1pc3Npb25zU3RvcmUgfSBmcm9tICcuLi9zdG9yZS9wZXJtaXNzaW9ucy5zdG9yZSc7XHJcblxyXG5pbXBvcnQgeyBpc0Jvb2xlYW4sIGlzRnVuY3Rpb24sIHRyYW5zZm9ybVN0cmluZ1RvQXJyYXkgfSBmcm9tICcuLi91dGlscy91dGlscyc7XHJcblxyXG5leHBvcnQgdHlwZSBOZ3hQZXJtaXNzaW9uc09iamVjdCA9IHsgW25hbWU6IHN0cmluZ106IE5neFBlcm1pc3Npb24gfTtcclxuXHJcbmV4cG9ydCBjb25zdCBVU0VfUEVSTUlTU0lPTlNfU1RPUkUgPSBuZXcgSW5qZWN0aW9uVG9rZW4oJ1VTRV9QRVJNSVNTSU9OU19TVE9SRScpO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgTmd4UGVybWlzc2lvbnNTZXJ2aWNlIHtcclxuXHJcbiAgICBwcml2YXRlIHBlcm1pc3Npb25zU291cmNlOiBCZWhhdmlvclN1YmplY3Q8Tmd4UGVybWlzc2lvbnNPYmplY3Q+O1xyXG4gICAgcHVibGljIHBlcm1pc3Npb25zJDogT2JzZXJ2YWJsZTxOZ3hQZXJtaXNzaW9uc09iamVjdD47XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgQEluamVjdChVU0VfUEVSTUlTU0lPTlNfU1RPUkUpIHByaXZhdGUgaXNvbGF0ZTogYm9vbGVhbiA9IGZhbHNlLFxyXG4gICAgICAgIHByaXZhdGUgcGVybWlzc2lvbnNTdG9yZTogTmd4UGVybWlzc2lvbnNTdG9yZVxyXG4gICAgKSB7XHJcbiAgICAgICAgdGhpcy5wZXJtaXNzaW9uc1NvdXJjZSA9IGlzb2xhdGUgPyBuZXcgQmVoYXZpb3JTdWJqZWN0PE5neFBlcm1pc3Npb25zT2JqZWN0Pih7fSkgOiBwZXJtaXNzaW9uc1N0b3JlLnBlcm1pc3Npb25zU291cmNlO1xyXG4gICAgICAgIHRoaXMucGVybWlzc2lvbnMkID0gdGhpcy5wZXJtaXNzaW9uc1NvdXJjZS5hc09ic2VydmFibGUoKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJlbW92ZSBhbGwgcGVybWlzc2lvbnMgZnJvbSBwZXJtaXNzaW9ucyBzb3VyY2VcclxuICAgICAqL1xyXG4gICAgcHVibGljIGZsdXNoUGVybWlzc2lvbnMoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5wZXJtaXNzaW9uc1NvdXJjZS5uZXh0KHt9KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgaGFzUGVybWlzc2lvbihwZXJtaXNzaW9uOiBzdHJpbmcgfCBzdHJpbmdbXSk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgICAgIGlmICghcGVybWlzc2lvbiB8fCAoQXJyYXkuaXNBcnJheShwZXJtaXNzaW9uKSAmJiBwZXJtaXNzaW9uLmxlbmd0aCA9PT0gMCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHBlcm1pc3Npb24gPSB0cmFuc2Zvcm1TdHJpbmdUb0FycmF5KHBlcm1pc3Npb24pO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmhhc0FycmF5UGVybWlzc2lvbihwZXJtaXNzaW9uKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgbG9hZFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBzdHJpbmdbXSwgdmFsaWRhdGlvbkZ1bmN0aW9uPzogRnVuY3Rpb24pOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBuZXdQZXJtaXNzaW9ucyA9IHBlcm1pc3Npb25zLnJlZHVjZSgoc291cmNlLCBwKSA9PlxyXG4gICAgICAgICAgICB0aGlzLnJlZHVjZVBlcm1pc3Npb24oc291cmNlLCBwLCB2YWxpZGF0aW9uRnVuY3Rpb24pXHJcbiAgICAgICAgICAgICwge30pO1xyXG5cclxuICAgICAgICB0aGlzLnBlcm1pc3Npb25zU291cmNlLm5leHQobmV3UGVybWlzc2lvbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhZGRQZXJtaXNzaW9uKHBlcm1pc3Npb246IHN0cmluZyB8IHN0cmluZ1tdLCB2YWxpZGF0aW9uRnVuY3Rpb24/OiBGdW5jdGlvbik6IHZvaWQge1xyXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHBlcm1pc3Npb24pKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBlcm1pc3Npb25zID0gcGVybWlzc2lvbi5yZWR1Y2UoKHNvdXJjZSwgcCkgPT5cclxuICAgICAgICAgICAgICAgIHRoaXMucmVkdWNlUGVybWlzc2lvbihzb3VyY2UsIHAsIHZhbGlkYXRpb25GdW5jdGlvbilcclxuICAgICAgICAgICAgICAgICwgdGhpcy5wZXJtaXNzaW9uc1NvdXJjZS52YWx1ZSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnBlcm1pc3Npb25zU291cmNlLm5leHQocGVybWlzc2lvbnMpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBlcm1pc3Npb25zID0gdGhpcy5yZWR1Y2VQZXJtaXNzaW9uKHRoaXMucGVybWlzc2lvbnNTb3VyY2UudmFsdWUsIHBlcm1pc3Npb24sIHZhbGlkYXRpb25GdW5jdGlvbik7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnBlcm1pc3Npb25zU291cmNlLm5leHQocGVybWlzc2lvbnMpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcmVtb3ZlUGVybWlzc2lvbihwZXJtaXNzaW9uTmFtZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbnMgPSB7XHJcbiAgICAgICAgICAgIC4uLnRoaXMucGVybWlzc2lvbnNTb3VyY2UudmFsdWVcclxuICAgICAgICB9O1xyXG4gICAgICAgIGRlbGV0ZSBwZXJtaXNzaW9uc1twZXJtaXNzaW9uTmFtZV07XHJcbiAgICAgICAgdGhpcy5wZXJtaXNzaW9uc1NvdXJjZS5uZXh0KHBlcm1pc3Npb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0UGVybWlzc2lvbihuYW1lOiBzdHJpbmcpOiBOZ3hQZXJtaXNzaW9uIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wZXJtaXNzaW9uc1NvdXJjZS52YWx1ZVtuYW1lXTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0UGVybWlzc2lvbnMoKTogTmd4UGVybWlzc2lvbnNPYmplY3Qge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnBlcm1pc3Npb25zU291cmNlLnZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVkdWNlUGVybWlzc2lvbihcclxuICAgICAgICBzb3VyY2U6IE5neFBlcm1pc3Npb25zT2JqZWN0LFxyXG4gICAgICAgIG5hbWU6IHN0cmluZyxcclxuICAgICAgICB2YWxpZGF0aW9uRnVuY3Rpb24/OiBGdW5jdGlvblxyXG4gICAgKTogTmd4UGVybWlzc2lvbnNPYmplY3Qge1xyXG4gICAgICAgIGlmICghIXZhbGlkYXRpb25GdW5jdGlvbiAmJiBpc0Z1bmN0aW9uKHZhbGlkYXRpb25GdW5jdGlvbikpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIC4uLnNvdXJjZSxcclxuICAgICAgICAgICAgICAgIFtuYW1lXTogeyBuYW1lLCB2YWxpZGF0aW9uRnVuY3Rpb24gfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAuLi5zb3VyY2UsXHJcbiAgICAgICAgICAgICAgICBbbmFtZV06IHsgbmFtZSB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaGFzQXJyYXlQZXJtaXNzaW9uKHBlcm1pc3Npb25zOiBzdHJpbmdbXSk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgICAgIGNvbnN0IHByb21pc2VzOiBPYnNlcnZhYmxlPGJvb2xlYW4+W10gPSBwZXJtaXNzaW9ucy5tYXAoKGtleSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5oYXNQZXJtaXNzaW9uVmFsaWRhdGlvbkZ1bmN0aW9uKGtleSkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGltbXV0YWJsZVZhbHVlID0geyAuLi50aGlzLnBlcm1pc3Npb25zU291cmNlLnZhbHVlIH07XHJcbiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZGF0aW9uRnVuY3Rpb246IEZ1bmN0aW9uID0gPEZ1bmN0aW9uPnRoaXMucGVybWlzc2lvbnNTb3VyY2UudmFsdWVba2V5XS52YWxpZGF0aW9uRnVuY3Rpb247XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9mKG51bGwpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgbWFwKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbGlkYXRpb25GdW5jdGlvbihrZXksIGltbXV0YWJsZVZhbHVlKVxyXG4gICAgICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgocHJvbWlzZTogUHJvbWlzZTxib29sZWFuPiB8IGJvb2xlYW4pOiBPYnNlcnZhYmxlSW5wdXQ8Ym9vbGVhbj4gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgYiA9IGlzQm9vbGVhbihwcm9taXNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihwcm9taXNlIGFzIGJvb2xlYW4pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb21pc2UgYXMgUHJvbWlzZTxib29sZWFuPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiBvZihmYWxzZSkpXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBjaGVjayBmb3IgbmFtZSBvZiB0aGUgcGVybWlzc2lvbiBpZiB0aGVyZSBpcyBubyB2YWxpZGF0aW9uIGZ1bmN0aW9uXHJcbiAgICAgICAgICAgIHJldHVybiBvZighIXRoaXMucGVybWlzc2lvbnNTb3VyY2UudmFsdWVba2V5XSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBmcm9tKHByb21pc2VzKS5waXBlKFxyXG4gICAgICAgICAgICBtZXJnZUFsbCgpLFxyXG4gICAgICAgICAgICBmaXJzdCgoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgciA9IGRhdGEgIT09IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHI7XHJcbiAgICAgICAgICAgIH0sIGZhbHNlKSxcclxuICAgICAgICAgICAgbWFwKChkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByID0gZGF0YSA9PT0gZmFsc2UgPyBmYWxzZSA6IHRydWU7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcjtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICApLnRvUHJvbWlzZSgpLnRoZW4oKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gZGF0YTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGhhc1Blcm1pc3Npb25WYWxpZGF0aW9uRnVuY3Rpb24oa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gISF0aGlzLnBlcm1pc3Npb25zU291cmNlLnZhbHVlW2tleV0gJiZcclxuICAgICAgICAgICAgISF0aGlzLnBlcm1pc3Npb25zU291cmNlLnZhbHVlW2tleV0udmFsaWRhdGlvbkZ1bmN0aW9uICYmXHJcbiAgICAgICAgICAgIGlzRnVuY3Rpb24odGhpcy5wZXJtaXNzaW9uc1NvdXJjZS52YWx1ZVtrZXldLnZhbGlkYXRpb25GdW5jdGlvbik7XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==