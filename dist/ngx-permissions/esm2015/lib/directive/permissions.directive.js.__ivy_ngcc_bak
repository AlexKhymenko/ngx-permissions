/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChangeDetectorRef, Directive, EventEmitter, Input, Output, TemplateRef, ViewContainerRef } from '@angular/core';
import { merge, from } from 'rxjs';
import { skip, take, mergeAll, first, map } from 'rxjs/operators';
import { NgxPermissionsPredefinedStrategies } from '../enums/predefined-strategies.enum';
import { NgxPermissionsConfigurationService } from '../service/configuration.service';
import { NgxPermissionsService } from '../service/permissions.service';
import { NgxRolesService } from '../service/roles.service';
import { isBoolean, isFunction, isString, notEmptyValue, transformStringToArray } from '../utils/utils';
import { isArray } from 'util';
export class NgxPermissionsDirective {
    /**
     * @param {?} permissionsService
     * @param {?} configurationService
     * @param {?} rolesService
     * @param {?} viewContainer
     * @param {?} changeDetector
     * @param {?} templateRef
     */
    constructor(permissionsService, configurationService, rolesService, viewContainer, changeDetector, templateRef) {
        this.permissionsService = permissionsService;
        this.configurationService = configurationService;
        this.rolesService = rolesService;
        this.viewContainer = viewContainer;
        this.changeDetector = changeDetector;
        this.templateRef = templateRef;
        this.permissionsAuthorized = new EventEmitter();
        this.permissionsUnauthorized = new EventEmitter();
        // skip first run cause merge will fire twice
        this.firstMergeUnusedRun = 1;
        this.permissionsState = {};
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.viewContainer.clear();
        this.initPermissionSubscription = this.validateExceptOnlyPermissions();
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        /** @type {?} */
        const onlyChanges = changes['ngxPermissionsOnly'];
        /** @type {?} */
        const exceptChanges = changes['ngxPermissionsExcept'];
        if (onlyChanges || exceptChanges) {
            // Due to bug when you pass empty array
            if (onlyChanges && onlyChanges.firstChange)
                return;
            if (exceptChanges && exceptChanges.firstChange)
                return;
            merge(this.permissionsService.permissions$, this.rolesService.roles$)
                .pipe(skip(this.firstMergeUnusedRun), take(1))
                .subscribe((/**
             * @return {?}
             */
            () => {
                if (notEmptyValue(this.ngxPermissionsExcept)) {
                    this.validateExceptAndOnlyPermissions();
                    return;
                }
                if (notEmptyValue(this.ngxPermissionsOnly)) {
                    this.validateOnlyPermissions();
                    return;
                }
                this.handleAuthorisedPermission(this.getAuthorisedTemplates());
            }));
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        if (this.initPermissionSubscription) {
            this.initPermissionSubscription.unsubscribe();
        }
    }
    /**
     * @private
     * @return {?}
     */
    validateExceptOnlyPermissions() {
        return merge(this.permissionsService.permissions$, this.rolesService.roles$)
            .pipe(skip(this.firstMergeUnusedRun))
            .subscribe((/**
         * @return {?}
         */
        () => {
            if (notEmptyValue(this.ngxPermissionsExcept)) {
                this.validateExceptAndOnlyPermissions();
                return;
            }
            if (notEmptyValue(this.ngxPermissionsOnly)) {
                this.validateOnlyPermissions();
                return;
            }
            this.handleAuthorisedPermission(this.getAuthorisedTemplates());
        }));
    }
    /**
     * @private
     * @return {?}
     */
    validateExceptAndOnlyPermissions() {
        this.getPermissions(this.ngxPermissionsExcept)
            .then((/**
         * @param {?} hasPermission
         * @return {?}
         */
        (hasPermission) => {
            if (hasPermission) {
                this.handleUnauthorisedPermission(this.ngxPermissionsExceptElse || this.ngxPermissionsElse);
                return;
            }
            if (!!this.ngxPermissionsOnly)
                throw false;
            this.handleAuthorisedPermission(this.ngxPermissionsExceptThen || this.ngxPermissionsThen || this.templateRef);
        }))
            .catch((/**
         * @return {?}
         */
        () => {
            if (!!this.ngxPermissionsOnly) {
                this.validateOnlyPermissions();
            }
            else {
                this.handleAuthorisedPermission(this.ngxPermissionsExceptThen || this.ngxPermissionsThen || this.templateRef);
            }
        }));
    }
    /**
     * @private
     * @return {?}
     */
    validateOnlyPermissions() {
        // Validate permissions & store permission state
        this.getPermissions(this.ngxPermissionsOnly)
            .then((/**
         * @param {?} hasPermission
         * @return {?}
         */
        (hasPermission) => {
            if (hasPermission) {
                this.handleAuthorisedPermission(this.ngxPermissionsOnlyThen || this.ngxPermissionsThen || this.templateRef);
            }
            else {
                this.handleUnauthorisedPermission(this.ngxPermissionsOnlyElse || this.ngxPermissionsElse);
            }
        }))
            .catch((/**
         * @return {?}
         */
        () => {
            this.handleUnauthorisedPermission(this.ngxPermissionsOnlyElse || this.ngxPermissionsElse);
        }));
    }
    /**
     * @private
     * @param {?} template
     * @return {?}
     */
    handleUnauthorisedPermission(template) {
        if (isBoolean(this.currentAuthorizedState) && !this.currentAuthorizedState)
            return;
        this.currentAuthorizedState = false;
        this.permissionsUnauthorized.emit(this.permissionsState);
        if (this.getUnAuthorizedStrategyInput()) {
            this.applyStrategyAccordingToStrategyType(this.getUnAuthorizedStrategyInput());
            return;
        }
        if (this.configurationService.onUnAuthorisedDefaultStrategy && !this.elseBlockDefined()) {
            this.applyStrategy(this.configurationService.onUnAuthorisedDefaultStrategy);
        }
        else {
            this.showTemplateBlockInView(template);
        }
    }
    /**
     * @private
     * @param {?} template
     * @return {?}
     */
    handleAuthorisedPermission(template) {
        if (isBoolean(this.currentAuthorizedState) && this.currentAuthorizedState)
            return;
        this.currentAuthorizedState = true;
        this.permissionsAuthorized.emit(this.permissionsState);
        if (this.getAuthorizedStrategyInput()) {
            this.applyStrategyAccordingToStrategyType(this.getAuthorizedStrategyInput());
            return;
        }
        if (this.configurationService.onAuthorisedDefaultStrategy && !this.thenBlockDefined()) {
            this.applyStrategy(this.configurationService.onAuthorisedDefaultStrategy);
        }
        else {
            this.showTemplateBlockInView(template);
        }
    }
    /**
     * @private
     * @param {?} strategy
     * @return {?}
     */
    applyStrategyAccordingToStrategyType(strategy) {
        if (isString(strategy)) {
            this.applyStrategy(strategy);
            return;
        }
        if (isFunction(strategy)) {
            this.showTemplateBlockInView(this.templateRef);
            ((/** @type {?} */ (strategy)))(this.templateRef, this.permissionsState);
            return;
        }
    }
    /**
     * @private
     * @param {?} template
     * @return {?}
     */
    showTemplateBlockInView(template) {
        this.viewContainer.clear();
        if (!template) {
            return;
        }
        this.viewContainer.createEmbeddedView(template);
        this.changeDetector.markForCheck();
    }
    /**
     * @private
     * @return {?}
     */
    getAuthorisedTemplates() {
        return this.ngxPermissionsOnlyThen
            || this.ngxPermissionsExceptThen
            || this.ngxPermissionsThen
            || this.templateRef;
    }
    /**
     * @private
     * @return {?}
     */
    elseBlockDefined() {
        return !!this.ngxPermissionsExceptElse || !!this.ngxPermissionsElse;
    }
    /**
     * @private
     * @return {?}
     */
    thenBlockDefined() {
        return !!this.ngxPermissionsExceptThen || !!this.ngxPermissionsThen;
    }
    /**
     * @private
     * @return {?}
     */
    getAuthorizedStrategyInput() {
        return this.ngxPermissionsOnlyAuthorisedStrategy ||
            this.ngxPermissionsExceptAuthorisedStrategy ||
            this.ngxPermissionsAuthorisedStrategy;
    }
    /**
     * @private
     * @return {?}
     */
    getUnAuthorizedStrategyInput() {
        return this.ngxPermissionsOnlyUnauthorisedStrategy ||
            this.ngxPermissionsExceptUnauthorisedStrategy ||
            this.ngxPermissionsUnauthorisedStrategy;
    }
    /**
     * @private
     * @param {?} str
     * @return {?}
     */
    applyStrategy(str) {
        if (str === NgxPermissionsPredefinedStrategies.SHOW) {
            this.showTemplateBlockInView(this.templateRef);
            return;
        }
        if (str === NgxPermissionsPredefinedStrategies.REMOVE) {
            this.viewContainer.clear();
            return;
        }
        /** @type {?} */
        const strategy = this.configurationService.getStrategy(str);
        this.showTemplateBlockInView(this.templateRef);
        strategy(this.templateRef, this.permissionsState);
    }
    /**
     * Check permission service against parameter "neddedPermissions"
     * then update this class property "permissionsState"
     *
     * @private
     * @param {?} neddedPermissions Sets the permissions/roles to check (i.e ngxPermissionsOnly)
     * @return {?}
     */
    getPermissions(neddedPermissions) {
        // Ensure we work with array
        /** @type {?} */
        var requestedPermissions = transformStringToArray(neddedPermissions)
        // Array of promises that request permission and roles service with "permission"
        ;
        // Array of promises that request permission and roles service with "permission"
        /** @type {?} */
        var promises = []
        // Reset "permissions state" directive class property
        ;
        // Reset "permissions state" directive class property
        this.permissionsState = {};
        if (isArray(requestedPermissions)) {
            requestedPermissions.forEach((/**
             * @param {?} value
             * @return {?}
             */
            (value) => {
                this.permissionsState[value] = { hasPermission: false, hasRole: false };
                // Check if has "Permission"
                promises.push(this.permissionsService.hasPermission(value)
                    .then((/**
                 * @param {?} hasPermission
                 * @return {?}
                 */
                (hasPermission) => {
                    this.permissionsState[value].hasPermission = hasPermission;
                    return hasPermission;
                }))
                    .catch((/**
                 * @return {?}
                 */
                () => false)));
                // Check if has "Role"
                promises.push(this.rolesService.hasOnlyRoles(value)
                    .then((/**
                 * @param {?} hasPermission
                 * @return {?}
                 */
                (hasPermission) => {
                    this.permissionsState[value].hasRole = hasPermission;
                    return hasPermission;
                }))
                    .catch((/**
                 * @return {?}
                 */
                () => false)));
            }));
        }
        /**
         * Return result :
         * true : At least one of neededPermission exists in permission or role service (@see this.permissionsState to get a full detail on wich permission is true/false)
         * false : none of neededPermission exists in  permission or role service
        */
        return from(promises).pipe(mergeAll(), first((/**
         * @param {?} hasPermission
         * @return {?}
         */
        (hasPermission) => {
            return hasPermission === true;
        }), false), map((/**
         * @param {?} hasPermission
         * @return {?}
         */
        (hasPermission) => {
            return hasPermission;
        }))).toPromise().then((/**
         * @param {?} hasPermission
         * @return {?}
         */
        (hasPermission) => {
            return hasPermission;
        }));
    }
}
NgxPermissionsDirective.decorators = [
    { type: Directive, args: [{
                selector: '[ngxPermissionsOnly],[ngxPermissionsExcept]'
            },] }
];
/** @nocollapse */
NgxPermissionsDirective.ctorParameters = () => [
    { type: NgxPermissionsService },
    { type: NgxPermissionsConfigurationService },
    { type: NgxRolesService },
    { type: ViewContainerRef },
    { type: ChangeDetectorRef },
    { type: TemplateRef }
];
NgxPermissionsDirective.propDecorators = {
    ngxPermissionsOnly: [{ type: Input }],
    ngxPermissionsOnlyThen: [{ type: Input }],
    ngxPermissionsOnlyElse: [{ type: Input }],
    ngxPermissionsExcept: [{ type: Input }],
    ngxPermissionsExceptElse: [{ type: Input }],
    ngxPermissionsExceptThen: [{ type: Input }],
    ngxPermissionsThen: [{ type: Input }],
    ngxPermissionsElse: [{ type: Input }],
    ngxPermissionsOnlyAuthorisedStrategy: [{ type: Input }],
    ngxPermissionsOnlyUnauthorisedStrategy: [{ type: Input }],
    ngxPermissionsExceptUnauthorisedStrategy: [{ type: Input }],
    ngxPermissionsExceptAuthorisedStrategy: [{ type: Input }],
    ngxPermissionsUnauthorisedStrategy: [{ type: Input }],
    ngxPermissionsAuthorisedStrategy: [{ type: Input }],
    permissionsAuthorized: [{ type: Output }],
    permissionsUnauthorized: [{ type: Output }]
};
if (false) {
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsOnly;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsOnlyThen;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsOnlyElse;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsExcept;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsExceptElse;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsExceptThen;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsThen;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsElse;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsOnlyAuthorisedStrategy;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsOnlyUnauthorisedStrategy;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsExceptUnauthorisedStrategy;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsExceptAuthorisedStrategy;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsUnauthorisedStrategy;
    /** @type {?} */
    NgxPermissionsDirective.prototype.ngxPermissionsAuthorisedStrategy;
    /** @type {?} */
    NgxPermissionsDirective.prototype.permissionsAuthorized;
    /** @type {?} */
    NgxPermissionsDirective.prototype.permissionsUnauthorized;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.initPermissionSubscription;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.firstMergeUnusedRun;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.currentAuthorizedState;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.permissionsState;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.permissionsService;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.configurationService;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.rolesService;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.viewContainer;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.changeDetector;
    /**
     * @type {?}
     * @private
     */
    NgxPermissionsDirective.prototype.templateRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbnMuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXBlcm1pc3Npb25zLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZS9wZXJtaXNzaW9ucy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFDSCxpQkFBaUIsRUFDakIsU0FBUyxFQUNULFlBQVksRUFDWixLQUFLLEVBR0wsTUFBTSxFQUNOLFdBQVcsRUFDWCxnQkFBZ0IsRUFDbkIsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFFLEtBQUssRUFBZ0IsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pELE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFbEUsT0FBTyxFQUFFLGtDQUFrQyxFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDekYsT0FBTyxFQUFFLGtDQUFrQyxFQUFvQixNQUFNLGtDQUFrQyxDQUFDO0FBQ3hHLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsYUFBYSxFQUFFLHNCQUFzQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEcsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQVEvQixNQUFNLE9BQU8sdUJBQXVCOzs7Ozs7Ozs7SUErQmhDLFlBQ1ksa0JBQXlDLEVBQ3pDLG9CQUF3RCxFQUN4RCxZQUE2QixFQUM3QixhQUErQixFQUMvQixjQUFpQyxFQUNqQyxXQUE2QjtRQUw3Qix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQXVCO1FBQ3pDLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBb0M7UUFDeEQsaUJBQVksR0FB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QWdDOzs7OztJQUNoQyx5REFBd0M7Ozs7O0lBQ3hDLG1EQUEwQzs7Ozs7SUFHdEMscURBQWlEOzs7OztJQUNqRCx1REFBZ0U7Ozs7O0lBQ2hFLCtDQUFxQzs7Ozs7SUFDckMsZ0RBQXVDOzs7OztJQUN2QyxpREFBeUM7Ozs7O0lBQ3pDLDhDQUFxQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgICBDaGFuZ2VEZXRlY3RvclJlZixcclxuICAgIERpcmVjdGl2ZSxcclxuICAgIEV2ZW50RW1pdHRlcixcclxuICAgIElucHV0LCBPbkNoYW5nZXMsXHJcbiAgICBPbkRlc3Ryb3ksXHJcbiAgICBPbkluaXQsXHJcbiAgICBPdXRwdXQsIFNpbXBsZUNoYW5nZXMsXHJcbiAgICBUZW1wbGF0ZVJlZixcclxuICAgIFZpZXdDb250YWluZXJSZWZcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmltcG9ydCB7IG1lcmdlLCBTdWJzY3JpcHRpb24sIGZyb20gfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgc2tpcCwgdGFrZSwgbWVyZ2VBbGwsIGZpcnN0LCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBOZ3hQZXJtaXNzaW9uc1ByZWRlZmluZWRTdHJhdGVnaWVzIH0gZnJvbSAnLi4vZW51bXMvcHJlZGVmaW5lZC1zdHJhdGVnaWVzLmVudW0nO1xyXG5pbXBvcnQgeyBOZ3hQZXJtaXNzaW9uc0NvbmZpZ3VyYXRpb25TZXJ2aWNlLCBTdHJhdGVneUZ1bmN0aW9uIH0gZnJvbSAnLi4vc2VydmljZS9jb25maWd1cmF0aW9uLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBOZ3hQZXJtaXNzaW9uc1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlL3Blcm1pc3Npb25zLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBOZ3hSb2xlc1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlL3JvbGVzLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBpc0Jvb2xlYW4sIGlzRnVuY3Rpb24sIGlzU3RyaW5nLCBub3RFbXB0eVZhbHVlLCB0cmFuc2Zvcm1TdHJpbmdUb0FycmF5IH0gZnJvbSAnLi4vdXRpbHMvdXRpbHMnO1xyXG5pbXBvcnQgeyBpc0FycmF5IH0gZnJvbSAndXRpbCc7XHJcblxyXG4vLyBTdHJ1Y3QuIHRvIGtlZXAgZGlyZWN0aXZlIHRyYWNrIG9mIHBlcm1pc3Npb25zIHN0YXRlc1xyXG5leHBvcnQgdHlwZSBQZXJtaXNzaW9uU3RhdGUgPSB7IFtwZXJtaXNzaW9uOiBzdHJpbmddOiB7IGhhc1Blcm1pc3Npb246IGJvb2xlYW4sIGhhc1JvbGU6IGJvb2xlYW4gfSB9XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICAgIHNlbGVjdG9yOiAnW25neFBlcm1pc3Npb25zT25seV0sW25neFBlcm1pc3Npb25zRXhjZXB0XSdcclxufSlcclxuZXhwb3J0IGNsYXNzIE5neFBlcm1pc3Npb25zRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIE9uQ2hhbmdlcyB7XHJcblxyXG4gICAgQElucHV0KCkgbmd4UGVybWlzc2lvbnNPbmx5OiBzdHJpbmcgfCBzdHJpbmdbXTtcclxuICAgIEBJbnB1dCgpIG5neFBlcm1pc3Npb25zT25seVRoZW46IFRlbXBsYXRlUmVmPGFueT47XHJcbiAgICBASW5wdXQoKSBuZ3hQZXJtaXNzaW9uc09ubHlFbHNlOiBUZW1wbGF0ZVJlZjxhbnk+O1xyXG5cclxuICAgIEBJbnB1dCgpIG5neFBlcm1pc3Npb25zRXhjZXB0OiBzdHJpbmcgfCBzdHJpbmdbXTtcclxuICAgIEBJbnB1dCgpIG5neFBlcm1pc3Npb25zRXhjZXB0RWxzZTogVGVtcGxhdGVSZWY8YW55PjtcclxuICAgIEBJbnB1dCgpIG5neFBlcm1pc3Npb25zRXhjZXB0VGhlbjogVGVtcGxhdGVSZWY8YW55PjtcclxuXHJcbiAgICBASW5wdXQoKSBuZ3hQZXJtaXNzaW9uc1RoZW46IFRlbXBsYXRlUmVmPGFueT47XHJcbiAgICBASW5wdXQoKSBuZ3hQZXJtaXNzaW9uc0Vsc2U6IFRlbXBsYXRlUmVmPGFueT47XHJcblxyXG4gICAgQElucHV0KCkgbmd4UGVybWlzc2lvbnNPbmx5QXV0aG9yaXNlZFN0cmF0ZWd5OiBzdHJpbmcgfCBTdHJhdGVneUZ1bmN0aW9uO1xyXG4gICAgQElucHV0KCkgbmd4UGVybWlzc2lvbnNPbmx5VW5hdXRob3Jpc2VkU3RyYXRlZ3k6IHN0cmluZyB8IFN0cmF0ZWd5RnVuY3Rpb247XHJcblxyXG4gICAgQElucHV0KCkgbmd4UGVybWlzc2lvbnNFeGNlcHRVbmF1dGhvcmlzZWRTdHJhdGVneTogc3RyaW5nIHwgU3RyYXRlZ3lGdW5jdGlvbjtcclxuICAgIEBJbnB1dCgpIG5neFBlcm1pc3Npb25zRXhjZXB0QXV0aG9yaXNlZFN0cmF0ZWd5OiBzdHJpbmcgfCBTdHJhdGVneUZ1bmN0aW9uO1xyXG5cclxuICAgIEBJbnB1dCgpIG5neFBlcm1pc3Npb25zVW5hdXRob3Jpc2VkU3RyYXRlZ3k6IHN0cmluZyB8IFN0cmF0ZWd5RnVuY3Rpb247XHJcbiAgICBASW5wdXQoKSBuZ3hQZXJtaXNzaW9uc0F1dGhvcmlzZWRTdHJhdGVneTogc3RyaW5nIHwgU3RyYXRlZ3lGdW5jdGlvbjtcclxuXHJcbiAgICBAT3V0cHV0KCkgcGVybWlzc2lvbnNBdXRob3JpemVkID0gbmV3IEV2ZW50RW1pdHRlcjxQZXJtaXNzaW9uU3RhdGU+KCk7XHJcbiAgICBAT3V0cHV0KCkgcGVybWlzc2lvbnNVbmF1dGhvcml6ZWQgPSBuZXcgRXZlbnRFbWl0dGVyPFBlcm1pc3Npb25TdGF0ZT4oKTtcclxuXHJcbiAgICBwcml2YXRlIGluaXRQZXJtaXNzaW9uU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XHJcbiAgICAvLyBza2lwIGZpcnN0IHJ1biBjYXVzZSBtZXJnZSB3aWxsIGZpcmUgdHdpY2VcclxuICAgIHByaXZhdGUgZmlyc3RNZXJnZVVudXNlZFJ1biA9IDE7XHJcbiAgICBwcml2YXRlIGN1cnJlbnRBdXRob3JpemVkU3RhdGU6IGJvb2xlYW47XHJcbiAgICBwcml2YXRlIHBlcm1pc3Npb25zU3RhdGU6IFBlcm1pc3Npb25TdGF0ZTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlIHBlcm1pc3Npb25zU2VydmljZTogTmd4UGVybWlzc2lvbnNTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgY29uZmlndXJhdGlvblNlcnZpY2U6IE5neFBlcm1pc3Npb25zQ29uZmlndXJhdGlvblNlcnZpY2UsXHJcbiAgICAgICAgcHJpdmF0ZSByb2xlc1NlcnZpY2U6IE5neFJvbGVzU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIHZpZXdDb250YWluZXI6IFZpZXdDb250YWluZXJSZWYsXHJcbiAgICAgICAgcHJpdmF0ZSBjaGFuZ2VEZXRlY3RvcjogQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgICAgICAgcHJpdmF0ZSB0ZW1wbGF0ZVJlZjogVGVtcGxhdGVSZWY8YW55PlxyXG4gICAgKSB7XHJcbiAgICAgICAgdGhpcy5wZXJtaXNzaW9uc1N0YXRlID0ge307XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy52aWV3Q29udGFpbmVyLmNsZWFyKCk7XHJcbiAgICAgICAgdGhpcy5pbml0UGVybWlzc2lvblN1YnNjcmlwdGlvbiA9IHRoaXMudmFsaWRhdGVFeGNlcHRPbmx5UGVybWlzc2lvbnMoKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IG9ubHlDaGFuZ2VzID0gY2hhbmdlc1snbmd4UGVybWlzc2lvbnNPbmx5J107XHJcbiAgICAgICAgY29uc3QgZXhjZXB0Q2hhbmdlcyA9IGNoYW5nZXNbJ25neFBlcm1pc3Npb25zRXhjZXB0J107XHJcbiAgICAgICAgaWYgKG9ubHlDaGFuZ2VzIHx8IGV4Y2VwdENoYW5nZXMpIHtcclxuICAgICAgICAgICAgLy8gRHVlIHRvIGJ1ZyB3aGVuIHlvdSBwYXNzIGVtcHR5IGFycmF5XHJcbiAgICAgICAgICAgIGlmIChvbmx5Q2hhbmdlcyAmJiBvbmx5Q2hhbmdlcy5maXJzdENoYW5nZSkgcmV0dXJuO1xyXG4gICAgICAgICAgICBpZiAoZXhjZXB0Q2hhbmdlcyAmJiBleGNlcHRDaGFuZ2VzLmZpcnN0Q2hhbmdlKSByZXR1cm47XHJcblxyXG4gICAgICAgICAgICBtZXJnZSh0aGlzLnBlcm1pc3Npb25zU2VydmljZS5wZXJtaXNzaW9ucyQsIHRoaXMucm9sZXNTZXJ2aWNlLnJvbGVzJClcclxuICAgICAgICAgICAgICAgIC5waXBlKHNraXAodGhpcy5maXJzdE1lcmdlVW51c2VkUnVuKSwgdGFrZSgxKSlcclxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChub3RFbXB0eVZhbHVlKHRoaXMubmd4UGVybWlzc2lvbnNFeGNlcHQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmFsaWRhdGVFeGNlcHRBbmRPbmx5UGVybWlzc2lvbnMoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5vdEVtcHR5VmFsdWUodGhpcy5uZ3hQZXJtaXNzaW9uc09ubHkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmFsaWRhdGVPbmx5UGVybWlzc2lvbnMoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVBdXRob3Jpc2VkUGVybWlzc2lvbih0aGlzLmdldEF1dGhvcmlzZWRUZW1wbGF0ZXMoKSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuaW5pdFBlcm1pc3Npb25TdWJzY3JpcHRpb24pIHtcclxuICAgICAgICAgICAgdGhpcy5pbml0UGVybWlzc2lvblN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHZhbGlkYXRlRXhjZXB0T25seVBlcm1pc3Npb25zKCk6IFN1YnNjcmlwdGlvbiB7XHJcbiAgICAgICAgcmV0dXJuIG1lcmdlKHRoaXMucGVybWlzc2lvbnNTZXJ2aWNlLnBlcm1pc3Npb25zJCwgdGhpcy5yb2xlc1NlcnZpY2Uucm9sZXMkKVxyXG4gICAgICAgICAgICAucGlwZShza2lwKHRoaXMuZmlyc3RNZXJnZVVudXNlZFJ1bikpXHJcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKG5vdEVtcHR5VmFsdWUodGhpcy5uZ3hQZXJtaXNzaW9uc0V4Y2VwdCkpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnZhbGlkYXRlRXhjZXB0QW5kT25seVBlcm1pc3Npb25zKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChub3RFbXB0eVZhbHVlKHRoaXMubmd4UGVybWlzc2lvbnNPbmx5KSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudmFsaWRhdGVPbmx5UGVybWlzc2lvbnMoKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUF1dGhvcmlzZWRQZXJtaXNzaW9uKHRoaXMuZ2V0QXV0aG9yaXNlZFRlbXBsYXRlcygpKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB2YWxpZGF0ZUV4Y2VwdEFuZE9ubHlQZXJtaXNzaW9ucygpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmdldFBlcm1pc3Npb25zKHRoaXMubmd4UGVybWlzc2lvbnNFeGNlcHQpXHJcbiAgICAgICAgICAgIC50aGVuKChoYXNQZXJtaXNzaW9uOiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaGFzUGVybWlzc2lvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlVW5hdXRob3Jpc2VkUGVybWlzc2lvbih0aGlzLm5neFBlcm1pc3Npb25zRXhjZXB0RWxzZSB8fCB0aGlzLm5neFBlcm1pc3Npb25zRWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKCEhdGhpcy5uZ3hQZXJtaXNzaW9uc09ubHkpIHRocm93IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVBdXRob3Jpc2VkUGVybWlzc2lvbih0aGlzLm5neFBlcm1pc3Npb25zRXhjZXB0VGhlbiB8fCB0aGlzLm5neFBlcm1pc3Npb25zVGhlbiB8fCB0aGlzLnRlbXBsYXRlUmVmKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICghIXRoaXMubmd4UGVybWlzc2lvbnNPbmx5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy52YWxpZGF0ZU9ubHlQZXJtaXNzaW9ucygpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUF1dGhvcmlzZWRQZXJtaXNzaW9uKHRoaXMubmd4UGVybWlzc2lvbnNFeGNlcHRUaGVuIHx8IHRoaXMubmd4UGVybWlzc2lvbnNUaGVuIHx8IHRoaXMudGVtcGxhdGVSZWYpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHZhbGlkYXRlT25seVBlcm1pc3Npb25zKCk6IHZvaWQge1xyXG4gICAgICAgIC8vIFZhbGlkYXRlIHBlcm1pc3Npb25zICYgc3RvcmUgcGVybWlzc2lvbiBzdGF0ZVxyXG4gICAgICAgIHRoaXMuZ2V0UGVybWlzc2lvbnModGhpcy5uZ3hQZXJtaXNzaW9uc09ubHkpXHJcbiAgICAgICAgICAgIC50aGVuKChoYXNQZXJtaXNzaW9uOiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaGFzUGVybWlzc2lvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQXV0aG9yaXNlZFBlcm1pc3Npb24odGhpcy5uZ3hQZXJtaXNzaW9uc09ubHlUaGVuIHx8IHRoaXMubmd4UGVybWlzc2lvbnNUaGVuIHx8IHRoaXMudGVtcGxhdGVSZWYpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVVuYXV0aG9yaXNlZFBlcm1pc3Npb24odGhpcy5uZ3hQZXJtaXNzaW9uc09ubHlFbHNlIHx8IHRoaXMubmd4UGVybWlzc2lvbnNFbHNlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlVW5hdXRob3Jpc2VkUGVybWlzc2lvbih0aGlzLm5neFBlcm1pc3Npb25zT25seUVsc2UgfHwgdGhpcy5uZ3hQZXJtaXNzaW9uc0Vsc2UpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGhhbmRsZVVuYXV0aG9yaXNlZFBlcm1pc3Npb24odGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT4pOiB2b2lkIHtcclxuICAgICAgICBpZiAoaXNCb29sZWFuKHRoaXMuY3VycmVudEF1dGhvcml6ZWRTdGF0ZSkgJiYgIXRoaXMuY3VycmVudEF1dGhvcml6ZWRTdGF0ZSkgcmV0dXJuO1xyXG5cclxuICAgICAgICB0aGlzLmN1cnJlbnRBdXRob3JpemVkU3RhdGUgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnBlcm1pc3Npb25zVW5hdXRob3JpemVkLmVtaXQodGhpcy5wZXJtaXNzaW9uc1N0YXRlKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuZ2V0VW5BdXRob3JpemVkU3RyYXRlZ3lJbnB1dCgpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYXBwbHlTdHJhdGVneUFjY29yZGluZ1RvU3RyYXRlZ3lUeXBlKHRoaXMuZ2V0VW5BdXRob3JpemVkU3RyYXRlZ3lJbnB1dCgpKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuY29uZmlndXJhdGlvblNlcnZpY2Uub25VbkF1dGhvcmlzZWREZWZhdWx0U3RyYXRlZ3kgJiYgIXRoaXMuZWxzZUJsb2NrRGVmaW5lZCgpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYXBwbHlTdHJhdGVneSh0aGlzLmNvbmZpZ3VyYXRpb25TZXJ2aWNlLm9uVW5BdXRob3Jpc2VkRGVmYXVsdFN0cmF0ZWd5KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnNob3dUZW1wbGF0ZUJsb2NrSW5WaWV3KHRlbXBsYXRlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaGFuZGxlQXV0aG9yaXNlZFBlcm1pc3Npb24odGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT4pOiB2b2lkIHtcclxuICAgICAgICBpZiAoaXNCb29sZWFuKHRoaXMuY3VycmVudEF1dGhvcml6ZWRTdGF0ZSkgJiYgdGhpcy5jdXJyZW50QXV0aG9yaXplZFN0YXRlKSByZXR1cm47XHJcblxyXG4gICAgICAgIHRoaXMuY3VycmVudEF1dGhvcml6ZWRTdGF0ZSA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5wZXJtaXNzaW9uc0F1dGhvcml6ZWQuZW1pdCh0aGlzLnBlcm1pc3Npb25zU3RhdGUpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5nZXRBdXRob3JpemVkU3RyYXRlZ3lJbnB1dCgpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYXBwbHlTdHJhdGVneUFjY29yZGluZ1RvU3RyYXRlZ3lUeXBlKHRoaXMuZ2V0QXV0aG9yaXplZFN0cmF0ZWd5SW5wdXQoKSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmNvbmZpZ3VyYXRpb25TZXJ2aWNlLm9uQXV0aG9yaXNlZERlZmF1bHRTdHJhdGVneSAmJiAhdGhpcy50aGVuQmxvY2tEZWZpbmVkKCkpIHtcclxuICAgICAgICAgICAgdGhpcy5hcHBseVN0cmF0ZWd5KHRoaXMuY29uZmlndXJhdGlvblNlcnZpY2Uub25BdXRob3Jpc2VkRGVmYXVsdFN0cmF0ZWd5KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnNob3dUZW1wbGF0ZUJsb2NrSW5WaWV3KHRlbXBsYXRlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhcHBseVN0cmF0ZWd5QWNjb3JkaW5nVG9TdHJhdGVneVR5cGUoc3RyYXRlZ3k6IHN0cmluZyB8IEZ1bmN0aW9uKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKGlzU3RyaW5nKHN0cmF0ZWd5KSkge1xyXG4gICAgICAgICAgICB0aGlzLmFwcGx5U3RyYXRlZ3koc3RyYXRlZ3kpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoaXNGdW5jdGlvbihzdHJhdGVneSkpIHtcclxuICAgICAgICAgICAgdGhpcy5zaG93VGVtcGxhdGVCbG9ja0luVmlldyh0aGlzLnRlbXBsYXRlUmVmKTtcclxuICAgICAgICAgICAgKHN0cmF0ZWd5IGFzIEZ1bmN0aW9uKSh0aGlzLnRlbXBsYXRlUmVmLCB0aGlzLnBlcm1pc3Npb25zU3RhdGUpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2hvd1RlbXBsYXRlQmxvY2tJblZpZXcodGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT4pOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnZpZXdDb250YWluZXIuY2xlYXIoKTtcclxuICAgICAgICBpZiAoIXRlbXBsYXRlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMudmlld0NvbnRhaW5lci5jcmVhdGVFbWJlZGRlZFZpZXcodGVtcGxhdGUpO1xyXG4gICAgICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IubWFya0ZvckNoZWNrKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRBdXRob3Jpc2VkVGVtcGxhdGVzKCk6IFRlbXBsYXRlUmVmPGFueT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm5neFBlcm1pc3Npb25zT25seVRoZW5cclxuICAgICAgICAgICAgfHwgdGhpcy5uZ3hQZXJtaXNzaW9uc0V4Y2VwdFRoZW5cclxuICAgICAgICAgICAgfHwgdGhpcy5uZ3hQZXJtaXNzaW9uc1RoZW5cclxuICAgICAgICAgICAgfHwgdGhpcy50ZW1wbGF0ZVJlZjtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGVsc2VCbG9ja0RlZmluZWQoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuICEhdGhpcy5uZ3hQZXJtaXNzaW9uc0V4Y2VwdEVsc2UgfHwgISF0aGlzLm5neFBlcm1pc3Npb25zRWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHRoZW5CbG9ja0RlZmluZWQoKSB7XHJcbiAgICAgICAgcmV0dXJuICEhdGhpcy5uZ3hQZXJtaXNzaW9uc0V4Y2VwdFRoZW4gfHwgISF0aGlzLm5neFBlcm1pc3Npb25zVGhlbjtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldEF1dGhvcml6ZWRTdHJhdGVneUlucHV0KCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm5neFBlcm1pc3Npb25zT25seUF1dGhvcmlzZWRTdHJhdGVneSB8fFxyXG4gICAgICAgICAgICB0aGlzLm5neFBlcm1pc3Npb25zRXhjZXB0QXV0aG9yaXNlZFN0cmF0ZWd5IHx8XHJcbiAgICAgICAgICAgIHRoaXMubmd4UGVybWlzc2lvbnNBdXRob3Jpc2VkU3RyYXRlZ3k7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRVbkF1dGhvcml6ZWRTdHJhdGVneUlucHV0KCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm5neFBlcm1pc3Npb25zT25seVVuYXV0aG9yaXNlZFN0cmF0ZWd5IHx8XHJcbiAgICAgICAgICAgIHRoaXMubmd4UGVybWlzc2lvbnNFeGNlcHRVbmF1dGhvcmlzZWRTdHJhdGVneSB8fFxyXG4gICAgICAgICAgICB0aGlzLm5neFBlcm1pc3Npb25zVW5hdXRob3Jpc2VkU3RyYXRlZ3k7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhcHBseVN0cmF0ZWd5KHN0cjogYW55KSB7XHJcbiAgICAgICAgaWYgKHN0ciA9PT0gTmd4UGVybWlzc2lvbnNQcmVkZWZpbmVkU3RyYXRlZ2llcy5TSE9XKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2hvd1RlbXBsYXRlQmxvY2tJblZpZXcodGhpcy50ZW1wbGF0ZVJlZik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChzdHIgPT09IE5neFBlcm1pc3Npb25zUHJlZGVmaW5lZFN0cmF0ZWdpZXMuUkVNT1ZFKSB7XHJcbiAgICAgICAgICAgIHRoaXMudmlld0NvbnRhaW5lci5jbGVhcigpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHN0cmF0ZWd5ID0gdGhpcy5jb25maWd1cmF0aW9uU2VydmljZS5nZXRTdHJhdGVneShzdHIpO1xyXG4gICAgICAgIHRoaXMuc2hvd1RlbXBsYXRlQmxvY2tJblZpZXcodGhpcy50ZW1wbGF0ZVJlZik7XHJcblxyXG4gICAgICAgIHN0cmF0ZWd5KHRoaXMudGVtcGxhdGVSZWYsIHRoaXMucGVybWlzc2lvbnNTdGF0ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDaGVjayBwZXJtaXNzaW9uIHNlcnZpY2UgYWdhaW5zdCBwYXJhbWV0ZXIgXCJuZWRkZWRQZXJtaXNzaW9uc1wiXHJcbiAgICAgKiB0aGVuIHVwZGF0ZSB0aGlzIGNsYXNzIHByb3BlcnR5IFwicGVybWlzc2lvbnNTdGF0ZVwiXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSBuZWRkZWRQZXJtaXNzaW9ucyBTZXRzIHRoZSBwZXJtaXNzaW9ucy9yb2xlcyB0byBjaGVjayAoaS5lIG5neFBlcm1pc3Npb25zT25seSlcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBnZXRQZXJtaXNzaW9ucyhuZWRkZWRQZXJtaXNzaW9uczogc3RyaW5nIHwgc3RyaW5nW10pOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuXHJcbiAgICAgICAgLy8gRW5zdXJlIHdlIHdvcmsgd2l0aCBhcnJheVxyXG4gICAgICAgIHZhciByZXF1ZXN0ZWRQZXJtaXNzaW9uczogQXJyYXk8c3RyaW5nPiA9IHRyYW5zZm9ybVN0cmluZ1RvQXJyYXkobmVkZGVkUGVybWlzc2lvbnMpXHJcblxyXG4gICAgICAgIC8vIEFycmF5IG9mIHByb21pc2VzIHRoYXQgcmVxdWVzdCBwZXJtaXNzaW9uIGFuZCByb2xlcyBzZXJ2aWNlIHdpdGggXCJwZXJtaXNzaW9uXCJcclxuICAgICAgICB2YXIgcHJvbWlzZXM6IFByb21pc2U8Ym9vbGVhbj5bXSA9IFtdXHJcblxyXG4gICAgICAgIC8vIFJlc2V0IFwicGVybWlzc2lvbnMgc3RhdGVcIiBkaXJlY3RpdmUgY2xhc3MgcHJvcGVydHlcclxuICAgICAgICB0aGlzLnBlcm1pc3Npb25zU3RhdGUgPSB7fVxyXG5cclxuICAgICAgICBpZiAoaXNBcnJheShyZXF1ZXN0ZWRQZXJtaXNzaW9ucykpIHtcclxuICAgICAgICAgICAgcmVxdWVzdGVkUGVybWlzc2lvbnMuZm9yRWFjaCgodmFsdWUpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMucGVybWlzc2lvbnNTdGF0ZVt2YWx1ZV0gPSB7IGhhc1Blcm1pc3Npb246IGZhbHNlLCBoYXNSb2xlOiBmYWxzZSB9XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgaGFzIFwiUGVybWlzc2lvblwiXHJcbiAgICAgICAgICAgICAgICBwcm9taXNlcy5wdXNoKFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGVybWlzc2lvbnNTZXJ2aWNlLmhhc1Blcm1pc3Npb24odmFsdWUpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChoYXNQZXJtaXNzaW9uKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcm1pc3Npb25zU3RhdGVbdmFsdWVdLmhhc1Blcm1pc3Npb24gPSBoYXNQZXJtaXNzaW9uXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGFzUGVybWlzc2lvbjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKCgpID0+IGZhbHNlKVxyXG4gICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgaGFzIFwiUm9sZVwiXHJcbiAgICAgICAgICAgICAgICBwcm9taXNlcy5wdXNoKFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucm9sZXNTZXJ2aWNlLmhhc09ubHlSb2xlcyh2YWx1ZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKGhhc1Blcm1pc3Npb24pID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGVybWlzc2lvbnNTdGF0ZVt2YWx1ZV0uaGFzUm9sZSA9IGhhc1Blcm1pc3Npb25cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBoYXNQZXJtaXNzaW9uO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKCkgPT4gZmFsc2UpXHJcbiAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvKiogXHJcbiAgICAgICAgICogUmV0dXJuIHJlc3VsdCA6XHJcbiAgICAgICAgICogdHJ1ZSA6IEF0IGxlYXN0IG9uZSBvZiBuZWVkZWRQZXJtaXNzaW9uIGV4aXN0cyBpbiBwZXJtaXNzaW9uIG9yIHJvbGUgc2VydmljZSAoQHNlZSB0aGlzLnBlcm1pc3Npb25zU3RhdGUgdG8gZ2V0IGEgZnVsbCBkZXRhaWwgb24gd2ljaCBwZXJtaXNzaW9uIGlzIHRydWUvZmFsc2UpXHJcbiAgICAgICAgICogZmFsc2UgOiBub25lIG9mIG5lZWRlZFBlcm1pc3Npb24gZXhpc3RzIGluICBwZXJtaXNzaW9uIG9yIHJvbGUgc2VydmljZVxyXG4gICAgICAgICovXHJcbiAgICAgICAgcmV0dXJuIGZyb20ocHJvbWlzZXMpLnBpcGUoXHJcbiAgICAgICAgICAgIG1lcmdlQWxsKCksXHJcbiAgICAgICAgICAgIGZpcnN0KChoYXNQZXJtaXNzaW9uOiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaGFzUGVybWlzc2lvbiA9PT0gdHJ1ZTtcclxuICAgICAgICAgICAgfSwgZmFsc2UpLFxyXG4gICAgICAgICAgICBtYXAoKGhhc1Blcm1pc3Npb24pID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBoYXNQZXJtaXNzaW9uO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICkudG9Qcm9taXNlKCkudGhlbigoaGFzUGVybWlzc2lvbjogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gaGFzUGVybWlzc2lvblxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==